---
title: "KNZ_L0_data_wrangling"
authors: Smriti Pehim Limbu, Joshua Ajowele
Collaborators: Grassland Rocks working group
date: "2023-12-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##package upload
```{r}
install.packages(pacman)
library(pacman)
pacman::p_load(readr, ggplot2, dplyr, tidyverse, gtools, lubridate, codyn) #lubridate is to change the date format

```

##set working directory
```{r}
L0_dir <- Sys.getenv("L0DIR")
L1_dir <- Sys.getenv("L1DIR")
L2_dir <- Sys.getenv("L2DIR")
list.files(L0_dir)
```

##Load files, more needs to be loaded

```{r}
df_A1_KNZ <- read.csv(file.path(L0_dir, "KNZ/A1_CME011_Sppcomp.csv"), stringsAsFactors = FALSE)
df_A2_KNZ <- read.csv(file.path(L0_dir, "KNZ/A2_CME012_Biomass.csv"), stringsAsFactors = FALSE)

#Joshua's directory
df_E1_KNZ<-read.csv("C:/Users/JAAJOWELE/Downloads/E1_PPL011_Sppcomp.csv")
df_E2_KNZ<-read.csv("C:/Users/JAAJOWELE/Downloads/E2_PPL012_Biomass.csv")


df_J1_KNZ <- read.csv(file.path(L0_dir, "KNZ/J1_CEE012_Sppcomp.csv"), stringsAsFactors = FALSE)
df_J2_KNZ <- read.csv(file.path(L0_dir, "KNZ/J2_CEE014_Biomass.csv"), stringsAsFactors = FALSE)


```

#climate data

```{r}

df_ppt <- read.csv(file.path(L0_dir, "KNZ/Precipitation_1982_2023.csv"), stringsAsFactors = FALSE)
# Convert the date column to Date type 
df_ppt$RecDate<- as.Date(df_ppt$RecDate, format = "%m/%d/%Y")

# Extract the year from the date
df_ppt$year <- year(df_ppt$RecDate)


```


#Cleaning CEE data J1 and J2 - Smriti

```{r}

#renaming variables

df_J1_KNZ.clean <- df_J1_KNZ %>% rename(year = Year, species = Spnum2, abundance=Cover)

#adding site name, watershed name, blocks, and higher_order_organization

df_J2_KNZ.clean <- df_J2_KNZ %>% rename(year = Year)  %>% mutate(site = "KNZ") %>% mutate(watershed="HQ") %>% mutate(Block =case_when(Plot%in% c(101, 102, 103, 104, 105, 106, 107, 108, 109, 110)~"1", Plot%in% c(101, 102, 103, 104, 105, 106, 107, 108, 109, 110)~"1",Plot%in% c(201, 202,203, 204, 205, 206, 207, 208, 209, 210)~"2", Plot%in% c(301, 302, 303, 304, 305, 306, 307, 308, 309, 310)~"3",Plot%in% c(401, 402, 403, 404, 405, 406, 407, 408, 409, 410)~"4")) %>%  unite(higher_order_organization,site, watershed,Block,Plot, sep ="_", remove=FALSE)


#calculate richness and evenness

df_J1_richness_evenness <- community_structure(df_J1_KNZ.clean, time.var = "year", replicate.var = "Plot", abundance.var = "abundance", metric="SimpsonEvenness")

#add richness and evenness to the biomass data

df_J2_KNZ.clean.richness.evenness <- left_join (df_J2_KNZ.clean, df_J1_richness_evenness, by = c("year", "Plot"))


```

#cleaning data E1 and E2 - Joshua
```{r}
#check each column for uniqueness for E1 and E2 data
unique(df_E1_KNZ$RecYear)#2020 missing due to covid
unique(df_E2_KNZ$RecYear)#2020 data present
unique(df_E1_KNZ$Treatment)#looks good, 8 treatments
unique(df_E2_KNZ$Treatment)#looks good, 8 treatment
unique(df_E1_KNZ$PlotID)#48 plots
unique(df_E2_KNZ$PlotID)#48 plots

#clean and wrangle sp comp data
df_E1_KNZ_clean<-df_E1_KNZ%>%
  rename(year=RecYear)%>%
  unite(species_name,Genus,Species, sep = "_")%>%
#unique(df_E1_KNZ_clean$species_name)#no obvious duplicate 
  group_by(year, PlotID, Treatment)%>%
  mutate(total_abundance=sum(Abundance))%>%
  group_by(year, PlotID, Treatment, species_name)%>%
  mutate(relative_abundance=(Abundance/total_abundance)*100)%>%
  ungroup()%>%
  #create unique identifier for codyn package for community metric
  unite(plot, PlotID, Treatment, sep="_")
  #ready for richness/diversity calculation with codyn package

#calculate diversity/richness/evenness

E1_richness<-df_E1_KNZ_clean%>%
  community_diversity(time.var="year",abundance.var="relative_abundance",
                      replicate.var="plot",metric = "Shannon")
E1_diversity<-df_E1_KNZ_clean%>%
  #calculates richness and evenness as Evar
  community_structure(time.var="year",abundance.var="relative_abundance",
                      replicate.var="plot")%>%
  left_join(E1_richness, by=c("year","plot"))%>%
  separate_wider_delim(plot,"_", names=c("PlotID","Treatment"))
#convert to integer to allow joining with biomass data
E1_diversity$PlotID=as.integer(E1_diversity$PlotID)

#clean and wrangle complementary biomass data and join with spcomp data

#create a treatment key
treatment_key=tibble(Treatment=levels(factor(df_E2_KNZ$Treatment)),                        treatment_key=c("control","N0P2.5","N0P5","N0P10",
                                    "N10P0","N10P2.5","N10P5","N10P10"))

#clean biomass data and join with spcomp data
df_E1_E2_KNZ_clean<-df_E2_KNZ%>%
  rename(year=RecYear, plot_biomass=ANPP)%>%
  mutate(site="KNZ", fire_frequency=2, grazing="ungrazed", 
         watershed="2c")%>%
  left_join(E1_diversity, by=c("year","Treatment", "PlotID"))%>%
  left_join(treatment_key, by="Treatment")
#ready to merge with other data set

```

