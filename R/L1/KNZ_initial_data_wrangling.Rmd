---
title: "KNZ_L0_data_wrangling"
authors: Smriti Pehim Limbu, Joshua Ajowele
Collaborators: Grassland Rocks working group
date: "2023-12-11" Last Modified: "Oct 4, 2024"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##package upload
```{r}
install.packages(pacman)
library(pacman)
pacman::p_load(readr, ggplot2, dplyr, tidyverse, gtools, lubridate, codyn) #lubridate is to change the date format

```

##set working directory
```{r}
L0_dir <- Sys.getenv("L0DIR")
L1_dir <- Sys.getenv("L1DIR")
L2_dir <- Sys.getenv("L2DIR")
list.files(L0_dir)
```

##Load files, more needs to be loaded

```{r}
df_A1_KNZ <- read.csv(file.path(L0_dir, "KNZ/A1_CME011_Sppcomp.csv"), stringsAsFactors = FALSE)
df_A2_KNZ <- read.csv(file.path(L0_dir, "KNZ/A2_CME012_Biomass.csv"), stringsAsFactors = FALSE)

#Joshua's directory
#df_E1_KNZ<-read.csv("C:/Users/JAAJOWELE/Downloads/E1_PPL011_Sppcomp.csv")
#df_E2_KNZ<-read.csv("C:/Users/JAAJOWELE/Downloads/E2_PPL012_Biomass.csv")
#loading from google drive-Joshua
df_E1_KNZ<-read.csv(file.path(L0_dir, "KNZ/E1_PPL011_Sppcomp.csv"))
df_E2_KNZ<-read.csv(file.path(L0_dir, "KNZ/E2_PPL012_Biomass.csv"))
df_J1_KNZ <- read.csv(file.path(L0_dir, "KNZ/J1_CEE012_Sppcomp.csv"), stringsAsFactors = FALSE)
df_J2_KNZ <- read.csv(file.path(L0_dir, "KNZ/J2_CEE014_Biomass.csv"), stringsAsFactors = FALSE)

#Alex's directory
#df_C1_KNZ <- read.csv("C:\\Users\\jasig\\Downloads\\C1_WAT012_Sppcomp.csv")
#df_C2_KNZ <- read.csv("C:\\Users\\jasig\\Downloads\\C2_WAT013_Biomass.csv")
#df_ppt <- read.csv("C:\\Users\\jasig\\Downloads\\Precipitation_1982_2023.csv")

#loading directly via google drive
df_C1_KNZ<-read.csv(file.path(L0_dir, "KNZ/C1_WAT012_Sppcomp.csv"))
df_C2_KNZ<-read.csv(file.path(L0_dir, "KNZ/C2_WAT013_Biomass.csv"))

#(Alex is dumb & is taking this approach) Convert the date column to Date type 
#df_ppt$RecDate<- as.Date(df_ppt$RecDate, format = "%m/%d/%Y")
#Extract the year from the date
#df_ppt$year <- year(df_ppt$RecDate)
#Reading temp data
#df_temp <- read.csv("C:\\Users\\jasig\\Downloads\\Temperature_1982_2023.csv")
```

#climate data

```{r}
df_ppt <- read.csv(file.path(L0_dir, "KNZ/Precipitation_1982_2023.csv"), stringsAsFactors = FALSE)
df_temp <- read.csv(file.path(L0_dir, "KNZ/Temperature_1982_2023.csv"), stringsAsFactors = FALSE)
# Convert the date column to Date type 
df_ppt$RecDate<- as.Date(df_ppt$RecDate, format = "%m/%d/%Y")
# Extract the year from the date
df_ppt$year <- year(df_ppt$RecDate)

# Summarizing temperature data
# Averaging across months
df_temp_ave_month <- df_temp %>% 
  group_by(RECYEAR, RECMONTH) %>%
  summarize(mean=mean(as.numeric(TAVE)))

# Averaging across years
df_temp_ave_year <- df_temp %>% 
  group_by(RECYEAR) %>%
  summarize(mean=mean(as.numeric(TAVE)))
```


#Cleaning CEE data J1 and J2 - Smriti

```{r}

#renaming variables

df_J1_KNZ.clean <- df_J1_KNZ %>% rename(year = Year, species = Spnum2, abundance=Cover)

#adding site name, watershed name, blocks, and higher_order_organization

df_J2_KNZ.clean <- df_J2_KNZ %>% rename(year = Year)  %>% mutate(site = "KNZ") %>% mutate(watershed="HQ") %>% mutate(Block =case_when(Plot%in% c(101, 102, 103, 104, 105, 106, 107, 108, 109, 110)~"1", Plot%in% c(101, 102, 103, 104, 105, 106, 107, 108, 109, 110)~"1",Plot%in% c(201, 202,203, 204, 205, 206, 207, 208, 209, 210)~"2", Plot%in% c(301, 302, 303, 304, 305, 306, 307, 308, 309, 310)~"3",Plot%in% c(401, 402, 403, 404, 405, 406, 407, 408, 409, 410)~"4")) %>%  unite(higher_order_organization,site, watershed,Block,Plot, sep ="_", remove=FALSE)


#calculate richness and evenness

df_J1_richness_evenness <- community_structure(df_J1_KNZ.clean, time.var = "year", replicate.var = "Plot", abundance.var = "abundance", metric="SimpsonEvenness")

#add richness and evenness to the biomass data

df_J2_KNZ.clean.richness.evenness <- left_join (df_J2_KNZ.clean, df_J1_richness_evenness, by = c("year", "Plot"))%>%
  rename(plot_biomass=Total)%>%
  rename(plot=Plot)%>%
  rename(evenness=SimpsonEvenness)


```

#cleaning data E1 and E2 - Joshua
```{r}
#check each column for uniqueness for E1 and E2 data
unique(df_E1_KNZ$RecYear)#2020 missing due to covid
unique(df_E2_KNZ$RecYear)#2020 data present
unique(df_E1_KNZ$Treatment)#looks good, 8 treatments
unique(df_E2_KNZ$Treatment)#looks good, 8 treatment
unique(df_E1_KNZ$PlotID)#48 plots
unique(df_E2_KNZ$PlotID)#48 plots

#clean and wrangle sp comp data
df_E1_KNZ_clean_sppcomp<-df_E1_KNZ%>%
  rename(year=RecYear)%>%
  unite(species_name,Genus,Species, sep = "_")%>%
#unique(df_E1_KNZ_clean$species_name)#no obvious duplicate 
  group_by(year, PlotID, Treatment)%>%
  mutate(total_abundance=sum(Abundance))%>%
  group_by(year, PlotID, Treatment, species_name)%>%
  mutate(relative_abundance=(Abundance/total_abundance)*100)%>%
  ungroup()%>%
  rename(abundance=Abundance,
         plot=PlotID,species=species_name)%>%
  mutate(original_measurement_unit="%cover",
         site="KNZ",
         higher_order_organization=paste(site,"PPLOT","2C",sep="_"),
         uniqueid=paste(higher_order_organization,plot,sep="_"))%>%
  #create unique identifier for codyn package for community metric
  mutate(PlotID=paste(plot,Treatment, sep="_"))#ready for richness/diversity calculation with codyn package

#ready to join with other Konza species comp data
df_E1_KNZ_species_level<-df_E1_KNZ_clean_sppcomp%>%
  mutate(relative_abundance=relative_abundance/100)
  

#calculate diversity/richness/evenness
#I used Evar for evenness because it is independent of species richness
E1_richness<-df_E1_KNZ_clean_sppcomp%>%
  community_diversity(time.var="year",abundance.var="relative_abundance",
                      replicate.var="PlotID",metric = "Shannon")
E1_diversity<-df_E1_KNZ_clean_sppcomp%>%
  #calculates richness and evenness as Evar
  community_structure(time.var="year",abundance.var="relative_abundance",
                      replicate.var="PlotID")%>%
  left_join(E1_richness, by=c("year","PlotID"))%>%
  separate_wider_delim(PlotID,"_", names=c("plot","Treatment"))%>%
  filter(year!=2002)
#convert to integer to allow joining with biomass data
E1_diversity$plot=as.integer(E1_diversity$plot)

#clean and wrangle complementary biomass data and join with spcomp data

#create a treatment key
treatment_key=tibble(Treatment=levels(factor(df_E2_KNZ$Treatment)),                        treatment_key=c("control","N0P2.5","N0P5","N0P10",
                                    "N10P0","N10P2.5","N10P5","N10P10"))

#clean biomass data and join with richness data
df_E1_E2_KNZ_clean_plot_metrics<-df_E2_KNZ%>%
  rename(year=RecYear, plot_biomass=ANPP,plot=PlotID)%>%
  mutate(site="KNZ")%>%
  left_join(E1_diversity, by=c("year","Treatment", "plot"))%>%
  left_join(treatment_key, by="Treatment")%>%
  rename(treatment=treatment_key, evenness=Evar)%>%
  mutate(site="KNZ",
         higher_order_organization=paste(site,"PPLOT","2C",sep="_"),
         uniqueid=paste(higher_order_organization,plot,sep="_"),
         measurement_scale_biomass=0.1,
         measurement_scale_cover=1)%>%
  filter(year!=2002)
#ready to merge with other plot metric data set

#create metadata 
#create metadata keys
treatment_key_metadata=tibble(treatment=levels(factor(df_E1_E2_KNZ_clean_plot_metrics$treatment)),               nutrient_added=c("no_fertilizer","P","P","P","N","NP","NP","NP"),
                              nitrogen_amount=c(0,0,0,0,10,10,10,10),
                              phosphorus_amount=c(0,10,2.5,5,0,10,2.5,5),
                              disturbance="undisturbed",
                              watershed="2C",
                              treatment_comment="NA",
                              grazing="ungrazed",
                              fire_frequency=2,
                              diversity_manipulated="naturally_assembled",)
#key for time since fire
time_since_fire_key=tibble(year=levels(factor(df_E1_E2_KNZ_clean_plot_metrics$year)),                        time_since_fire=c(0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0)                                     )
#convert year to integer
time_since_fire_key$year=as.integer(time_since_fire_key$year)
df_E1_E2_metadata<-df_E1_E2_KNZ_clean_plot_metrics%>%
  select(1:5,7,11:13)%>%
  left_join(treatment_key_metadata, by="treatment")%>%
  rename(source=DataCode)%>%
  left_join(time_since_fire_key, by="year")%>%
  #2002 is pretreatment data so easier to remove from the rest of the data
  filter(year!=2002)
#ready to merge with other Konza metadata


```

#Cleaning data C1 & C2 - Alex's code (uploaded and edited by Joshua)
```{r}
##Species comp
#Merging Genus & Species columns
df_C1_KNZ$species <- paste(df_C1_KNZ$Genus,df_C1_KNZ$Species)
#Removing unnecessary columns
df_C1_KNZ = df_C1_KNZ %>%
  select(-c("Rectype","Genus","Species"))
#convert cover class to percentage cover
cover_class_key<-data.frame(Cover=c(1:7),
                            abundance=c(0.5,3,15,37.5,62.5,85,97.5))
df_C1_KNZ<-df_C1_KNZ%>%
  left_join(cover_class_key, by="Cover")
#Renaming columns
df_C1_KNZ.clean <- df_C1_KNZ %>% rename(year = RecYear, treatment = Trt, transect = Transect, plot = Plot, species_code = Spcode)
#Adding columns
df_C1_KNZ.clean <- df_C1_KNZ.clean %>% 
  mutate(site = "KNZ")
#Checking columns for uniqueness
unique(df_C1_KNZ.clean$year) #1991-2022
unique(df_C1_KNZ.clean$treatment) #Three treatments (a & i, c starts in 2018)
unique(df_C1_KNZ.clean$plot) #30 plots (no #9?, added plots in 1993)
unique(df_C1_KNZ.clean$transect) #Four transects
## Must consider treatment reversal for this experiment ##

unique(df_C1_KNZ.clean$treatment)
df_C1_KNZ.clean$treatment[df_C1_KNZ.clean$treatment=="c"]<-"a"
#clean and wrangle spp comp data
df_C1_KNZ.clean<-df_C1_KNZ.clean%>%
  group_by(year, plot, treatment)%>%
  mutate(total_abundance=sum(abundance))%>%
  filter(year!=2022)%>%
  group_by(year, plot, treatment, species)%>%
  mutate(relative_abundance=(abundance/total_abundance)*100)%>%
  ungroup()%>%
  #create unique identifier for codyn package for community metric
  unite(plot_trt, plot, treatment, sep="_", remove=FALSE)

#calculate diversity/richness/evenness
C1_richness<-df_C1_KNZ.clean%>%
  community_diversity(time.var="year",abundance.var="relative_abundance",
                      replicate.var="plot_trt",metric = "Shannon")
C1_diversity<-df_C1_KNZ.clean%>%
  #calculates richness and evenness as Evar
  community_structure(time.var="year",abundance.var="relative_abundance",
                      replicate.var="plot_trt")%>%
  left_join(C1_richness, by=c("year","plot_trt"))%>%
  separate_wider_delim(plot_trt,"_", names=c("plot","treatment"))
#convert to integer to allow joining with biomass data
C1_diversity$plot=as.integer(C1_diversity$plot)


df_C1_KNZ.cleanest <- df_C1_KNZ.clean %>%
  mutate(method="sorted_to_species",
         experiment="WAT01",
         cover_method = "physical_quantity",
         area_sampled_bio = 10,
         area_sampled_cover = 0.1) %>%
  unite(higher_level_organization,site,experiment,plot, sep ="_", remove=FALSE) %>%
  unite(unique_id,site,experiment,year,plot_trt, sep ="_", remove=FALSE)
  
df_C1_KNZ.cleanest = df_C1_KNZ.cleanest[-c(1,5,6,9,13)]
names(df_C1_KNZ.cleanest)[names(df_C1_KNZ.cleanest) == "higher_level_organization"] = "higher_order_organization"
df_C1_KNZ.cleanest<-df_C1_KNZ.cleanest%>%
  rename(measurement_scale_cover=area_sampled_bio)%>%
  mutate(original_measurement_unit="%cover")
#Writing sppcomp dataset to upload to L1 folder
#write.csv(df_C1_KNZ.cleanest,"C:\\Users\\jasig\\Downloads\\df_C1_KNZ.cleanest.csv", row.names=FALSE)


##Biomass data
df_C2_KNZ.cleaner <- df_C2_KNZ %>%
  select(-c("RECMONTH","COMMENTS")) %>%
  rename(DataCode=DATACODE, year=RECYEAR, watershed=WATERSHED, treatment=TRANSECT, plot=PLOT, replicate=REPLICATE, livegrass=LIVEGRASS, forbs=FORBS, woody=WOODY, currentdead=CURRENTDEAD)
#Creating ANPP column
df_C2_KNZ.cleaner$livegrass = as.numeric(df_C2_KNZ.cleaner$livegrass)
df_C2_KNZ.cleaner$forbs = as.numeric(df_C2_KNZ.cleaner$forbs)
df_C2_KNZ.cleaner$woody = as.numeric(df_C2_KNZ.cleaner$woody)
df_C2_KNZ.cleaner$currentdead=as.numeric(df_C2_KNZ.cleaner$currentdead)
#turn na into zero
df_C2_KNZ.cleaner$currentdead[is.na(df_C2_KNZ.cleaner$currentdead)]<-0
df_C2_KNZ.cleaner$livegrass[is.na(df_C2_KNZ.cleaner$livegrass)]<-0
df_C2_KNZ.cleaner$forbs[is.na(df_C2_KNZ.cleaner$forbs)]<-0
df_C2_KNZ.cleaner$woody[is.na(df_C2_KNZ.cleaner$woody)]<-0

df_C2_KNZ.cleaner$total_biomass = df_C2_KNZ.cleaner$livegrass + df_C2_KNZ.cleaner$forbs + df_C2_KNZ.cleaner$woody+df_C2_KNZ.cleaner$currentdead

unique(df_C2_KNZ.cleaner$treatment) 

#Calculating plot_biomass and more
df_C2_KNZ.clean <- df_C2_KNZ.cleaner %>%
  group_by(year, plot) %>%
  mutate(plot_biomass = sum(total_biomass)) %>%
  mutate(mean_livegrass_rep = mean(livegrass)) %>%
  mutate(mean_forbs_rep = mean(forbs)) %>%
  mutate(mean_woody_rep = mean(woody)) %>%
  mutate(mean_biomass_rep = mean(total_biomass)) %>%
  mutate(site = "KNZ") %>%
#create unique identifier to consolidate reps
  unite(plot_trt, plot, treatment, sep="_", remove=FALSE)

#Subsetting to just include plots and their average biomass per functional group (to #account for four reps each)
df_C2_KNZ.noreps <- df_C2_KNZ.clean %>% 
  distinct(year, plot_trt, plot_biomass, .keep_all = T)
df_C2_KNZ.noreps <- df_C2_KNZ.noreps[-c(7:11,13:16)] %>%
  unite(higher_order_organization,site,DataCode,plot, sep ="_", remove=FALSE)

#Changing treatment naming conventions to match species comp
df_C2_KNZ.noreps$treatment[df_C2_KNZ.noreps$treatment=="c"]<-"a"
df_C2_KNZ.noreps$treatment[df_C2_KNZ.noreps$treatment=="ni"]<-"a"
df_C2_KNZ.noreps$treatment[df_C2_KNZ.noreps$treatment=="b"]<-"a"
df_C2_KNZ.noreps$treatment[df_C2_KNZ.noreps$treatment=="d"]<-"a"
unique(df_C2_KNZ.noreps$treatment)

df_C2_KNZ.noreps = mutate(df_C2_KNZ.noreps, plot_trt = paste(plot, treatment, sep ="_"))

df_C2_KNZ.noreps = mutate(df_C2_KNZ.noreps, unique_id = paste(site, year, plot_trt, sep="_"))

#Removing unnecessary columns
df_C2_KNZ.noreps = df_C2_KNZ.noreps[-c(2,4)]
#Adding column to make it possible to merge with diversity df
df_C2_KNZ.noreps = mutate(df_C2_KNZ.noreps, year_plot_trt = paste(year, plot_trt, sep="_"))

#Quick clean of diversity df
unique(C1_diversity$treatment)
C1_diversity = mutate(C1_diversity, year_plot_trt = paste(year, plot, treatment, sep="_"))
C1_diversity %>%
  unite(year_plot_trt, year, plot, treatment, sep="_", remove=FALSE)
C1_diversity = C1_diversity[-c(1:3)]

  
#Merging with diversity metrics
df_C2_KNZ_cleanest <- df_C2_KNZ.noreps %>%
  left_join(C1_diversity, by=c("year_plot_trt"))%>%
  mutate(measurement_scale_biomass="0.1")%>%
  rename(plot_biomass=total_biomass)
df_C2_KNZ_cleanest = df_C2_KNZ_cleanest[-c(3,7,10)]



#metadata
#Drop unnecessary columns
C1_Meta<-df_C2_KNZ_cleanest %>%
  dplyr::select(-plot_biomass,-richness,-Evar,-Shannon) #drop unneeded columns





#treatment:
C1_Meta[c('knz', 'watershed', 'plizot', 'treatment')] <- str_split_fixed(C1_Meta$unique_id, '_', 4)
#drop those new columns besides treatment
C1_Meta<-C1_Meta %>%
  dplyr::select(-knz, -plizot)
C1_Meta<-C1_Meta %>%
  dplyr::select(-watershed)

#nutrients_added:
C1_Meta$nutrients_added<-"no_fertilizer"

#disturbance:
C1_Meta$disturbance<-"undisturbed"

#grazing:
C1_Meta$grazing<-"ungrazed"

#fire_frequency:
C1_Meta$fire_frequency<-1

#time_since_fire: 
C1_Meta$time_since_fire<-0

#Source:
C1_Meta$source<-"WAT01"

#treatment_comment:
C1_Meta$treatment_comment<-"irrigation lines shifted in 2017"

#diversity_manipulated
C1_Meta$diversity_manipulated<-"naturally_assembled"



```


# Cleaning data D1 and D2 - Matt
```{r}

## bring in RaMPs data
# ramps <- read.csv("D1_D2_RMP011_Sppcomp_Biomass .csv",header = TRUE, sep = ",") # NOTICE there is a space before the .csv
#Note from Maya: I am going to read in data from the shared Google drive instead

ramps <- read.csv(file.path(L0_dir, "KNZ/D1_D2_RMP011_Sppcomp_Biomass .csv"), header = TRUE, sep = ",", stringsAsFactors = FALSE) # NOTICE there is a space before the .csv

#ramps$RecYear <- as.factor(ramps$RecYear)
ramps$season <- as.factor(ramps$season)
ramps$RampNo <- as.factor(ramps$RampNo)
ramps$Species <- as.factor(ramps$Species)


##### ANPP #####
RaMPs_ANPP_working <- ramps %>% 
  mutate(A_g_m2 = A*10,
         B_g_m2 = B*10,
         C_g_m2 = C*10,
         D_g_m2 = D*10) %>% 
  group_by(RecYear, season, RampNo) %>% 
  summarize(A_ANPP = sum(A_g_m2),
            B_ANPP = sum(B_g_m2),
            C_ANPP = sum(C_g_m2),
            D_ANPP = sum(D_g_m2)) %>% 
  tidyr::gather(key="plot", value="plot_biomass", A_ANPP, B_ANPP, C_ANPP, D_ANPP) %>% 
  mutate(plot = plyr::revalue(plot, c("A_ANPP" = "A",
                                      "B_ANPP" = "B",
                                      "C_ANPP" = "C",
                                      "D_ANPP" = "D")))

ambient_ramps <- c(3, 4, 6, 7, 11, 15)
altered_ramps <- c(2,5,9, 10, 12, 13)
control_ramps <- c(1, 8, 14)

levels(as.factor(RaMPs_ANPP_working$RampNo))
class(RaMPs_ANPP_working$RampNo)

RaMPs_ANPP <- RaMPs_ANPP_working %>% 
  dplyr::rename(year = RecYear,
                subplot = plot) %>% 
  filter(year!=1997)%>%
  mutate(site = "KNZ",
         ramps = "RampNo",
         experiment = "RaMPs",
         treatment  = case_when(RampNo %in% ambient_ramps ~ "ambient",
                                RampNo %in% altered_ramps ~ "altered",
                                RampNo %in% control_ramps ~ "control"),
         block = case_when(RampNo %in% c(1:5) ~ "Block1",
                           RampNo %in% c(6:10) ~ "Block2",
                           RampNo %in% c(11:15) ~ "Block3")) %>%
  filter(year != "1997") %>% # 1997 was year before shelters were put up
  #group_by(year, season, RampNo, site, ramps, experiment, treatment) %>% 
  #summarize(plot_biomass = mean(plot_biomass)) %>% 
  tidyr::unite("higher_order_organization", c(experiment, block), remove = F) %>% #ramps, RampNo
  tidyr::unite("uniqueID", c(higher_order_organization, ramps, RampNo, subplot), remove = F) %>%
  dplyr::rename(plot = RampNo) %>% 
  dplyr::select(year, season, site, plot, higher_order_organization, uniqueID, treatment, plot_biomass) %>% 
  mutate(nutrients_added = "no_fertilizer",
         nitrogen_added = 0,
         disturbance = "undisturbed",
         grazing = "ungrazed",
         fire_frequency = 1,
         time_since_fire = 0,
         diversity_manipulated = "naturally_assembled",
         measurement_scale_biomass = 0.1,
         richness = NA,
         evenness = NA,
         measurement_scale_cover = 0.1) %>% 
  mutate(treatment_comment = case_when(treatment == "altered" & as.numeric(year) <= 2001 ~ "Could be reduced quantity, altered pattern, or both",
                                       treatment == "altered" & as.numeric(year) == 2001 ~ "Reduced quantity ended",
                                       treatment == "altered" & as.numeric(year) >= 2003 ~ "Heat lamps added to two random subplots",
                                       treatment == "control" ~ "Unsheltered controls to account for effects from shelter infrastructure"))


# factors we need: year, site, plot, higher_order_organization, temperature, 
# precipitation, nutrients_added, nitrogen_amount, disturbance, grazing, 
# fire_frequency, time_since_fire, treatment comment, diversity_manipulated,
# plot_biomass, measurement_scale_biomass, richness, evenness, measurement_scale_cover


##### Community composition #####
ambient_ramps <- c(3, 4, 6, 7, 11, 15)
altered_ramps <- c(2,5,9, 10, 12, 13)
control_ramps <- c(1, 8, 14)

RaMPs_PlantCommunityComposition <- ramps %>% 
  mutate(A_g_m2 = A*10,
         B_g_m2 = B*10,
         C_g_m2 = C*10,
         D_g_m2 = D*10) %>% 
  dplyr::select(RecType,RecYear,season,RampNo,Species,A_g_m2,B_g_m2,C_g_m2,D_g_m2) %>% 
  dplyr::rename(A = A_g_m2,
                B = B_g_m2,
                C = C_g_m2,
                D = D_g_m2) %>% 
  tidyr::gather(key="plot", value="plot_biomass_spp", A, B, C, D) %>% 
  merge(., RaMPs_ANPP_working, 
        by=c("RecYear", "season", "RampNo", "plot")) %>% 
  mutate(relative_abundance = plot_biomass_spp/plot_biomass*100) %>% 
  dplyr::rename(year = RecYear,
                subplot = plot) %>% 
  mutate(site = "KNZ",
         ramps = "RampNo",
         experiment = "RaMPs",
         treatment  = case_when(RampNo %in% ambient_ramps ~ "ambient",
                                RampNo %in% altered_ramps ~ "altered",
                                RampNo %in% control_ramps ~ "control"),
         block = case_when(RampNo %in% c(1:5) ~ "Block1",
                           RampNo %in% c(6:10) ~ "Block2",
                           RampNo %in% c(11:15) ~ "Block3")) %>% 
  filter(year != "1997") %>% # 1997 was year before shelters were put up
  #group_by(year, season, RampNo, site, ramps, experiment, treatment) %>% 
  #summarize(plot_biomass = mean(plot_biomass)) %>% 
  tidyr::unite("higher_order_organization", c(experiment, block), remove = F) %>% #ramps, RampNo
  tidyr::unite("uniqueID", c(higher_order_organization, ramps, RampNo, subplot), remove = F) %>%
  dplyr::rename(plot = RampNo) %>% 
  dplyr::select(year, season, site, plot, higher_order_organization, uniqueID, treatment, relative_abundance, Species) %>% 
  mutate(nutrients_added = "no_fertilizer",
         nitrogen_added = 0,
         disturbance = "undisturbed",
         grazing = "ungrazed",
         fire_frequency = 1,
         time_since_fire = 0,
         diversity_manipulated = "naturally_assembled",
         measurement_scale_biomass = 0.1,
         measurement_scale_cover = 1,
         original_measurement_unit="biomass_g/m2") %>% 
  mutate(treatment_comment = case_when(treatment == "altered" & as.numeric(year) <= 2001 ~ "Could be reduced quantity, altered pattern, or both",
                                       treatment == "altered" & as.numeric(year) == 2001 ~ "Reduced quantity ended",
                                       treatment == "altered" & as.numeric(year) >= 2003 ~ "Heat lamps added to two random subplots",
                                       treatment == "control" ~ "Unsheltered controls to account for effects from shelter infrastructure"))%>%
  rename(species=Species)#is ambient different from control

#calculate species richness/diversity
diver_ramp_df<-RaMPs_PlantCommunityComposition%>%
  select(uniqueID,year,relative_abundance,species)%>%
  community_diversity(time.var="year",abundance.var="relative_abundance",
                      replicate.var="uniqueID",metric = "Shannon")
rich_ramp_df<-RaMPs_PlantCommunityComposition%>%
  select(uniqueID,year,relative_abundance,species)%>%
  #calculates richness and evenness as Evar
  community_structure(time.var="year",abundance.var="relative_abundance",
                      replicate.var="uniqueID")%>%
  left_join(diver_ramp_df, by=c("year","uniqueID"))

#combine diversity metrics with all composition data
RaMPs_PlantCommunityComposition<-RaMPs_PlantCommunityComposition%>%
  left_join(rich_ramp_df, by=c("year","uniqueID"))%>%
  mutate(relative_abundance=relative_abundance/100)


```


# Cleaning data A1 & A2 (ConSME)- Maya
Note: for ConSME, it looks like there are only 4 years of species comp data, and 2 years of biomass data. There should be more biomass data for sure though. 
```{r}

#Reading in the data
df_A1_KNZ <- read.csv(file.path(L0_dir, "KNZ/A1_CME011_Sppcomp.csv"), stringsAsFactors = FALSE)
df_A2_KNZ <- read.csv(file.path(L0_dir, "KNZ/A2_CME012_Biomass.csv"), stringsAsFactors = FALSE)
df_A3_KNZ <- read.csv(file.path(L0_dir, "KNZ/A3_CME01_treatments.csv"), stringsAsFactors = FALSE)

#I added the Konza species list to the drive as well
spplist <- read.csv(file.path(L0_dir, "KNZ/KNZ_specieslist_PPS011.csv"), stringsAsFactors = FALSE)


# Initial checks 
unique(df_A1_KNZ$RecYear) ##There are only 4 years of recorded species comp data: 2019-2022.  
unique(df_A2_KNZ$Recyear) ##There are only 2 years of recorded biomass data: 2020 & 2021.
unique(df_A1_KNZ$Watershed) ##2 watersheds: N1A & N4B
unique(df_A2_KNZ$Watershed) ##Same two watersheds: N1A & N4B
unique(sort(df_A1_KNZ$Block)) ##Blocks A-R
unique(sort(df_A2_KNZ$Block)) ##Same blocks A-R
unique(sort(df_A1_KNZ$Taxa)) ## Some non-plant observations that need to be removed; 


### A1 - sppcomp

## I am going to go ahead and remove non-plant things, and make invalid (negative) entries into 0's (NOT SURE IF THIS IS THE RIGHT PROTOCOL)
df_A1_KNZ.clean <- subset(df_A1_KNZ, !(Taxa %in% c("NA NA", "Dung ", "Rock ", 
                                                   "Litter", "Litter ", "Unknown seedlings")))
df_A1_KNZ.clean$Cover <- replace(df_A1_KNZ.clean$Cover, df_A1_KNZ.clean$Cover < 0, 0) 


## Looking through the dataset, I noticed some species names are different/misspelled and some entries are labelled with the wrong species number, so I am going to double check some species numbers, then just merge with the Konza species list to take care of the misspellings.

for(i in 1:nrow(df_A1_KNZ.clean)){
  if(df_A1_KNZ.clean$Taxa[i] == "Symphyotrichym (Aster) ericoides"){df_A1_KNZ.clean$Sppnum[i] <- 58}
  if(df_A1_KNZ.clean$Taxa[i] == "Symphyotrichym (Aster) oblongifolium"){df_A1_KNZ.clean$Sppnum[i] <- 59}
}


#Taking just the columns I want (for now) from the species list
spplist_short <- spplist %>% 
  unite(species, genus:species, sep = "_" ) %>%
  mutate(Sppnum = code) %>%
  dplyr::select(Sppnum, species) %>%
  add_case(Sppnum =c(-999, 0), 
           species = c("unknown","bare_ground"))

#Joining the species list and data together, so now we have correct spellings of species.
df_A1_KNZ.clean <- left_join(df_A1_KNZ.clean, spplist_short, by = "Sppnum")


#Rename columns to match datasheet outline
df_A1_KNZ.clean <- df_A1_KNZ.clean %>%
  mutate(site = as.factor("KNZ"),
         rectype = RecType,
         datacode = Datacode,
         year = as.numeric(RecYear),
         recdate = RecDate,
         season = as.factor(Season),
         watershed = as.factor(Watershed),
         block = Block,
         plot = Plot,
         sppcode = Sppnum,
         species = species,
         abundance = Cover,
         comments = Comments,
         experiment  = "ConSME",
         .keep = "unused") %>%
  unite(higher_order_organization, 
        experiment, site, watershed, 
        block, sep = "_", remove = FALSE) %>%
  unite(uniqueid, higher_order_organization, plot, sep = "_", remove = FALSE) %>%
  mutate(higher_order_organization = as.factor(higher_order_organization),
         uniqueid = as.factor(uniqueid),
         measurement_scale_cover = 1)

#Keeping the highest plot/species cover per season by summarizing data by the max abundance for every variable but season... there is probably a better way to do this lol.
df_A1_KNZ.clean <- df_A1_KNZ.clean %>% group_by(datacode, experiment, year, 
                                                 recdate, higher_order_organization, uniqueid, 
                                                 site, watershed, block,
                                                 plot, sppcode, species, Taxa, measurement_scale_cover, comments) %>% 
  summarize(abundance = max(abundance))


## Calculating relative abundance
df_A1_KNZ.clean <- df_A1_KNZ.clean %>%
 group_by(year, plot, uniqueid, watershed)%>%
  mutate(total_abundance = sum(abundance))%>%
  group_by(year, plot, uniqueid, watershed, species)%>%
  mutate(relative_abundance = (abundance/total_abundance) * 100)%>%
  ungroup()

## Calculating richness and evenness
A1_richness <- df_A1_KNZ.clean %>%
  community_diversity(time.var = "year",
                      abundance.var = "relative_abundance",
                      replicate.var = "uniqueid", metric = "Shannon")

A1_diversity <- df_A1_KNZ.clean %>% 
  #calculates richness and evenness as Evar
  community_structure(time.var = "year", 
                      abundance.var = "relative_abundance",
                      replicate.var = "uniqueid",
                      metric = "SimpsonEvenness") %>%
  left_join(A1_richness, by = c("year","uniqueid"))


#Creating an dataframe for all the distinct descriptive columns
df_A1_KNZ.env <- df_A1_KNZ.clean %>% 
    distinct(datacode, experiment, year, 
             higher_order_organization, uniqueid, 
             site, watershed, block, plot)

#Joining the diversity dataframe to the distinct columns dataframe
A1_diversity <- left_join(A1_diversity, df_A1_KNZ.env, by = c("year", "uniqueid"), keep = FALSE) %>%
  mutate(plot = as.factor(plot))
    


### A2-biomass

#Renaming variables so they match the sppcomp data (and so that they're all lowercase because I'm weird and I need things to match)
df_A2_KNZ.clean <- df_A2_KNZ %>%
  rename(datacode = DataCode,
         rectype = RecType,
         year = Recyear,
         watershed = Watershed,
         block = Block,
         plot = Plot,
         strip = Strip,
         lvgrass = Lvgrass,
         forb = Forb,
         woody = Woody,
         pdead = Pdead,
         comments = Comments
         ) %>% 
  mutate(site = "KNZ",
         experiment  = "ConSME") %>%
  unite(higher_order_organization, 
        experiment, site, watershed, 
        block, sep = "_", remove = FALSE) %>%
  unite(uniqueid, higher_order_organization, plot, sep = "_", remove = FALSE) %>%
  mutate(higher_order_organization = as.factor(higher_order_organization),
         uniqueid = as.factor(uniqueid))

#Replacing values that were recorded as -999 to 0 (NOT SURE IF THIS IS THE RIGHT PROTOCOL)
df_A2_KNZ.clean$lvgrass <- replace(df_A2_KNZ.clean$lvgrass, df_A2_KNZ.clean$lvgrass < 0, 0) 
df_A2_KNZ.clean$forb <- replace(df_A2_KNZ.clean$forb, df_A2_KNZ.clean$forb < 0, 0)
df_A2_KNZ.clean$woody <- replace(df_A2_KNZ.clean$woody, df_A2_KNZ.clean$woody < 0, 0)
df_A2_KNZ.clean$pdead <- replace(df_A2_KNZ.clean$pdead, df_A2_KNZ.clean$pdead < 0, 0)

#Since biomass was taken in 2 strips (both 1m2) per plot, I'm going to average the two strips for each plot... not sure if this is what we want... unfortunately, this gets rid of comments 
df_A2_KNZ.clean <- df_A2_KNZ.clean %>% group_by(datacode, year, higher_order_organization, uniqueid, watershed, block, plot) %>%
  summarize(lvgrass_avg = mean(lvgrass),
            forb_avg = mean(forb),
            woody_avg = mean(woody),
            pdead_avg = mean(pdead)) %>% 
  ungroup() %>%
  group_by(year, watershed, uniqueid, plot) %>% # Summing the biomass together -- does not include pdead
  mutate(plot_biomass = sum(lvgrass_avg, forb_avg, woody_avg)*10,
         plot = as.factor(plot)) %>%
  ungroup()




# Putting A1_diversity and A2 together
df_A1_A2_KNZ.clean <- left_join( df_A2_KNZ.clean,A1_diversity,
                                by = c("year", "higher_order_organization", "uniqueid", 
                                       "watershed", "block", "plot", "datacode"), keep = FALSE) %>%
  mutate(measurement_scale_cover = 1,
         measurement_scale_biomass = 0.1) %>%
  rename(source = datacode)

#END RESULTs: 
view(df_A1_KNZ.clean)
view(df_A1_A2_KNZ.clean)






#Taking the extra info and putting it into a new metadata data frame?
A1_A2_metadata <- df_A1_KNZ.env %>% mutate(fire_frequency = NA,
                                              grazing = "ungrazed",
                                              time_since_fire = NA,
                                           nutrients_added = NA,
                                           nitrogen_amount = NA,
                                           disturbance = NA) #I am unsure what we are counting as disturbance... like is bison grazing considered a disturbance?

#Choosing just the columns I want from the treatment dataset
df_A3_KNZ.short <- df_A3_KNZ %>% select(watershed, block, plot, trt)


#Joining the species comp data and treatment datasets
A1_A2_metadata <- left_join(A1_A2_metadata, df_A3_KNZ.short, by = c("watershed", "block", "plot")) %>%
  mutate(treatment = factor(trt),
         watershed = as.factor(watershed),
         .keep = "unused",
         treatment_comment = NA)

#NOTE: for treatment, the presence of an "B" mean bison were allowed on the plot, "S" means small mammals had access to the plot, and "I" means insects had access. The "X" in place of any of these letters means the herbivore was excluded.

#Adding in the fire and grazing info
for(i in 1:nrow(A1_A2_metadata)){
  if(A1_A2_metadata$watershed[i] == "N1A"){A1_A2_metadata$fire_frequency[i] <- 1}
  if(A1_A2_metadata$watershed[i] == "N4B"){A1_A2_metadata$fire_frequency[i] <- 4}
  if(A1_A2_metadata$watershed[i] == "N1A"){A1_A2_metadata$time_since_fire[i] <- 0}
  if(A1_A2_metadata$watershed[i] == "N4B" & A1_A2_metadata$year[i] == 2019){A1_A2_metadata$time_since_fire[i] <- 0}
  if(A1_A2_metadata$watershed[i] == "N4B" & A1_A2_metadata$year[i] == 2020){A1_A2_metadata$time_since_fire[i] <- 1} #I should put code to calculate this instead of writing it by hand so that it is more integrative, but there are only two watersheds and 4 years of data and I just wanna do it the dumb way for now
  if(A1_A2_metadata$watershed[i] == "N4B" & A1_A2_metadata$year[i] == 2021){A1_A2_metadata$time_since_fire[i] <- 2}
  if(A1_A2_metadata$watershed[i] == "N4B" & A1_A2_metadata$year[i] == 2022){A1_A2_metadata$time_since_fire[i] <- 3}
  if(A1_A2_metadata$treatment[i] == "BSI"){A1_A2_metadata$grazing[i] <- "grazed"}
  if(A1_A2_metadata$treatment[i] == "BSX"){A1_A2_metadata$grazing[i] <- "grazed"}
}
#how did you get the treatment names?

#I have not yet done the precip and temp data


```

# Cleaning data I1 & I2 (NutNet)- Maya
```{r}

#Reading in data
df_I1_KNZ <- read.csv(file.path(L0_dir, "KNZ/I1_NUT011_Sppcomp.csv"), stringsAsFactors = FALSE)
df_I2_KNZ <- read.csv(file.path(L0_dir, "KNZ/I2_NUT012_Biomass.csv"), stringsAsFactors = FALSE)


##Initial checks

#It does not include watershed info? The Konza website has a map indicating it is in 2C, but nothing is explicitly written in the metadata
unique(sort(df_I1_KNZ$RecYear)) #Data missing for 2020
unique(sort(df_I2_KNZ$RecYear)) #Data missing for 2013 and 2019

unique(sort(df_I1_KNZ$Block))# Blocks 1-3
#The biomass dataframe doesn't have blocks? I'll have to add them in 

unique(sort(df_I1_KNZ$Plot)) # Plots 1-30
unique(sort(df_I2_KNZ$Plot)) #Same plots 1-30

unique(sort(df_I1_KNZ$Subplot)) #Starts with "A", then goes "A1" to "A4", then repeats for B, C, D. It looks like just the "A", "B", "C", and "D" without the numbers attached might be the pre-treatment year only (2007)
unique(sort(df_I2_KNZ$Subplot)) #Has "1" and "2", then "A1" to "A4", then repeats for B, C, D. "1" and "2" are only for 2007, the pre-treatment year.

##I TALKED TO KIM AND SHE SAID SUBPLOT DOESN'T REALLY MATTER... JUST SUMMARIZE BY PLOT

#Might cut out the pre-treatment year (2007)? Unsure what we want to do... but since the plots are named differently too, it might just be easier.

unique(sort(df_I1_KNZ$Taxa)) #Some misspelled species and different capitalizations... will merge with the spp_list dataset to standardize the names for when we combine with other datasets





##Cleaning I1

#Removing 2007 from dataset since it was a pre-treatment year and has different plot names
#Also removing the one "litter" entry
df_I1_KNZ.clean <- df_I1_KNZ %>% subset(RecYear != 2007) %>% subset(Taxa != "litter")


#Redoing some of the sppcodes to match the Konza Spp list
#Also, I am making all the unknowns the same sppcode because that is what I did for ConSME data.
#Now I am second guessing what I am doing for the unknowns. Maybe they should be all be assigned their own spp code.
for(i in 1:nrow(df_I1_KNZ.clean)){
  # if(df_I1_KNZ.clean$Sppnum[i] == 946){df_I1_KNZ.clean$Sppnum[i] <- -999}
  if(df_I1_KNZ.clean$Sppnum[i] == 795){df_I1_KNZ.clean$Sppnum[i] <- 246}
  if(df_I1_KNZ.clean$Sppnum[i] == 726){df_I1_KNZ.clean$Sppnum[i] <- 246}
  # if(df_I1_KNZ.clean$Sppnum[i] == 792){df_I1_KNZ.clean$Sppnum[i] <- -999}
  # if(df_I1_KNZ.clean$Sppnum[i] == 708){df_I1_KNZ.clean$Sppnum[i] <- -999}
  if(df_I1_KNZ.clean$Sppnum[i] == 951){df_I1_KNZ.clean$Sppnum[i] <- 518}
  if(df_I1_KNZ.clean$Sppnum[i] == 746){df_I1_KNZ.clean$Sppnum[i] <- 289}
}

#Taking just the columns I want (for now) from the species list
#This us the same as what I did for ConSME data, just copying here so they can be run independently of each other
spplist_short <- spplist %>% 
  unite(species, genus:species, sep = "_" ) %>%
  mutate(Sppnum = code) %>%
  dplyr::select(Sppnum, species) %>%
  add_case(Sppnum =c(-999, 0), 
           species = c("unknown","bare_ground"))

#Joining with the shortened Konza species list
df_I1_KNZ.clean <- left_join(df_I1_KNZ.clean, spplist_short, by = "Sppnum")%>%
  select(!species)



#Renaming columns to match outline
df_I1_KNZ.clean <- df_I1_KNZ.clean %>%
  rename(rectype = RecType,
         source = DataCode,
         year = RecYear,
         date = Date,
         season = Season,
         block = Block,
         plot = Plot,
         sppcode = Sppnum,
         species = Taxa,
         abundance = Cover,
         comments = Comments) %>%
  group_by(rectype, source, year, date, block, plot, sppcode, species) %>% summarize(abundance = max(abundance)) %>% #taking the highest abundance per season, leaving out subplot
  mutate(site = as.factor("KNZ"),
         experiment  = "NUTNET") %>%
  unite(higher_order_organization, 
        experiment, site, sep = "_", remove = FALSE) %>% 
  unite(uniqueid, higher_order_organization, block, plot, sep = "_", remove = FALSE) %>%
  mutate(higher_order_organization = as.factor(higher_order_organization),
         uniqueid = as.factor(uniqueid),
         measurement_scale_cover = "1")


## Calculating relative abundance
df_I1_KNZ.clean <- df_I1_KNZ.clean %>%
 group_by(year, plot, uniqueid)%>%
  mutate(total_abundance = sum(abundance))%>%
  group_by(year, plot, uniqueid, species)%>%
  mutate(relative_abundance = (abundance/total_abundance) * 100)%>%
  ungroup() 

## Calculating richness and evenness
I1_richness <- df_I1_KNZ.clean %>%
  community_diversity(time.var = "year",
                      abundance.var = "relative_abundance",
                      replicate.var = "uniqueid", metric = "Shannon")

I1_diversity <- df_I1_KNZ.clean %>% 
  #calculates richness and evenness as Evar
  community_structure(time.var = "year", 
                      abundance.var = "relative_abundance",
                      replicate.var = "uniqueid",
                      metric = "SimpsonEvenness") %>%
  left_join(I1_richness, by = c("year","uniqueid"))
  
#Creating a dataframe for all the distinct descriptive columns
df_I1_KNZ.env <- df_I1_KNZ.clean %>% 
    distinct(source, experiment, year, higher_order_organization, uniqueid, site, block, plot, measurement_scale_cover)

#Joining the diversity dataframe to the distinct columns dataframe
I1_diversity <- left_join(I1_diversity, df_I1_KNZ.env, by = c("year", "uniqueid"), keep = FALSE) %>%
  mutate(plot = as.factor(plot))
    


### I2- NUTNET biomass

#Creating a dataframe to add blocks to the biomass

I2_blocks <- tibble(block = c(rep(1, 20), rep(2, 20), rep(3, 20)), Plot = c(rep(1:30, each = 2)))

df_I2_KNZ.clean <- left_join(df_I2_KNZ, I2_blocks, by = c("Plot"))

#Renaming variables so they match the sppcomp data (and so that they're all lowercase because I'm weird and I need things to match)
df_I2_KNZ.clean <- df_I2_KNZ.clean %>%
  subset(RecYear != 2007) %>% 
  rename(source = DataCode,
         rectype = RecType,
         year = RecYear,
         plot = Plot,
         lvgrass = Lvgrass,
         forb = Forbs,
         woody = Woody,
         pryrdead = Pryrdead,
         total = Total,
         comments = Comments
         ) %>% 
  group_by(source, rectype, year, block, plot) %>% summarize(lvgrass = mean(lvgrass), forb = mean(forb), woody = mean(woody), pryrdead = mean(pryrdead), total = mean(total)*10) %>%
  mutate(site = "KNZ",
         experiment  = "NUTNET") %>%
  unite(higher_order_organization,
        experiment, site, sep = "_", remove = FALSE) %>%
  unite(uniqueid, higher_order_organization, block, plot, sep = "_", remove = FALSE) %>%
  mutate(higher_order_organization = as.factor(higher_order_organization),
         plot = as.factor(plot),
         uniqueid = as.factor(uniqueid))

# Putting I1_diversity and I2 together
df_I1_I2_KNZ.clean <- left_join(df_I2_KNZ.clean, I1_diversity,
                                by = c("site", "year", "uniqueid", "higher_order_organization", 
                                       "plot", "block", "experiment", "source"), keep = FALSE) %>%
  mutate( measurement_scale_biomass = "0.1")

#After they wouldn't merge correctly, I noticed the plots:subplots are not the same for the diversity and biomass datasets...
unique(sort(I1_diversity$uniqueid))
unique(sort(df_I2_KNZ.clean$uniqueid))
unique(sort(df_I1_KNZ.clean$uniqueid))

#Treatment taken from Konza LTER website... it is a PDF, so I am just recreating the table I guess.
#I am also combining the "subplot" and "spp comp plot" from that table so that it matches these dataframes
KNZ_NUTNET_treatment <- tibble(block = c(rep(1, 10), rep(2, 10), rep(3, 10)),
                    plot = 1:30,
                    # subplot = c("A1", "B1", "D1", "D2", "C3", "B4", "C3", "B3", "C1", 
                    #            "A4", "B1", "D2", "D4", "C1", "B3", "B2", "D4", "D1",
                    #            "C2", "A4", "B4", "D1", "C4", "C1", "A2", "C1", "D2",
                    #            "B4", "C3", "C2"),
                    nutrients_added = c("NP", "NPK", "NPK", "none", "N", "PK", "P", "NK",
                                        "K", "none", "none", "PK", "P", "N", "NPK", "NPK",
                                        "K", "none", "NP", "NK", "none", "none", "P", "NK", 
                                        "N", "PK", "K", "NP", "NPK", "NPK"),
                    treatment = c("NP", "NPK", "NPK_fenced", "control", "N", "PK", "P", "NK",
                                        "K", "fenced", "fenced", "PK", "P", "N", "NPK_fenced", "NPK",
                                        "K", "control", "NP", "NK", "control", "fenced", "P", "NK", 
                                        "N", "PK", "K", "NP", "NPK_fenced", "NPK"),
                    exclosure = c("control", "control", "fenced", "control","control","control","control","control",
                                  "control","fenced", "fenced", "control","control","control","fenced", "control",
                                  "control","control","control","control","control","fenced", "control","control",
                                  "control","control","control","control","fenced", "control")) %>%
  mutate(site = "KNZ", 
         experiment = "NUTNET",
         plot = as.factor(plot),
         nutrients_added = as.factor(nutrients_added),
         treatment = as.factor(treatment),
         exclosure = as.factor(exclosure)) %>%
  unite(higher_order_organization,
        experiment, site, sep = "_", remove = FALSE) %>%
  unite(uniqueid, higher_order_organization, block, plot, sep = "_", remove = FALSE) 


#Final dataset
df_I1_I2_KNZ.clean <- left_join(df_I1_I2_KNZ.clean, KNZ_NUTNET_treatment,
                                by =c("uniqueid","plot","experiment","block","higher_order_organization","site"), keep = FALSE) 

```


#Mary's code
```{r}
#Mary's Code!!! for ChANGE K1_NGE01
# >:)

####Process and clean K1_NGE01_Sppcomp
#read in data, filter for correct years
#K1_spp<-read.csv("K1_NGE01_Sppcomp_RAW_no deluge plots_all years_20240515.csv")%>%
  #filter(year!=2013)%>% #subset all the pre-treatment 2013 year to avoid confusion
  #select(-X,-nitrogen,-treatment,-experiment) #drop unneeded columns
#loading from google drive
K1_spp<-read.csv(file.path(L0_dir, "KNZ/K1_NGE01_Sppcomp_RAW_no deluge plots_all years_20240515.csv"))%>%
  filter(year!=2013)%>% #subset all the pre-treatment 2013 year to avoid confusion
  select(-X,-nitrogen,-treatment,-experiment) #drop unneeded columns

#relative_abundance: calculate so all sum to 1
  #aggregate rows to sum cover across plot and get a "total cover" metric
totalcover_only<-aggregate(K1_spp$abundance,
                           by=list(higher_order_organization=K1_spp$higher_order_organization,
                                   plot=K1_spp$plot,
                                   site=K1_spp$site,
                                   year=K1_spp$year), FUN=sum)
names(totalcover_only)[names(totalcover_only)=="x"] <- "totalcover"

  #add totalcover value to main dataset
K1_spp<-merge(totalcover_only,K1_spp, by=c("site","plot","year","higher_order_organization"))

  #calculate relative abundance in new col then remove the "totalcover" col
K1_spp$relative_abundance <- (K1_spp$abundance/K1_spp$totalcover)
K1_spp <- K1_spp %>% select(-totalcover)

#combine block and plot for the uniqueid col
K1_spp$uniqueid<-paste(K1_spp$year,K1_spp$higher_order_organization,K1_spp$plot)

#site: update name to fit convention
K1_spp$site[K1_spp$site == 'knz']<-'KNZ'

#original_measurement_unit:
K1_spp$original_measurement_unit<-"%cover"

#write cleaned document
#write.csv(K1_spp, "K1_NGE01_Sppcomp.csv")


####Process and clean K2_NGE01_Biomass
#read in data, filter for correct years
#K1_mass<-read.csv("K2_NGE01_Biomass_RAW_no deluge plots_all years_20240515.csv")%>%
  #filter(year!=2013)%>%
  #rename(plot_biomass=anpp)%>%#subset all the pre-treatment 2013 year to avoid confusion
  #select(-X,-nitrogen,-treatment) #drop unneeded columns
#loading from google drive
K1_mass<-read.csv(file.path(L0_dir, "KNZ/K2_NGE01_Biomass_RAW_no deluge plots_all years_20240515.csv"))%>%
  filter(year!=2013)%>%
  rename(plot_biomass=anpp)%>%#subset all the pre-treatment 2013 year to avoid confusion
  select(-X,-nitrogen,-treatment) #drop unneeded columns

#combine block and plot for the uniqueid col
K1_mass$uniqueid<-paste(K1_mass$year,K1_mass$higher_order_organization,K1_mass$plot)

#calculate richness and diversity (as evenness) then merge with the main biomass dataset
K1_diversity <- community_structure(K1_spp, time.var = "year", abundance.var = "relative_abundance",
                                  replicate.var = "uniqueid", metric = c("Evar"))

K1_mass<-merge(K1_mass,K1_diversity, by=c("year","uniqueid"))

#add measurement_scale columns
K1_mass$measurement_scale_biomass<-0.1
K1_mass$measurement_scale_cover<-1

#write cleaned document
#write.csv(, "K2_NGE01_Biomass.csv")


####Create K1_NGE01K1_mass metadata file
#Read in biomass dataset and remove unneeded columns
K1_meta<-K1_mass%>%
  select(-measurement_scale_biomass,-measurement_scale_cover,-plot_biomass,-richness,-Evar) #drop unneeded columns

#Load in temperature data, calculate MAT, merge with main dataset
#df_temp <- read.csv("Temperature_1982_2023.csv")%>%
  #filter(TAVE!=".")%>%
  #rename(year=RECYEAR)

#df_temp_ave_year <- df_temp %>% 
  #group_by(year) %>%
  #summarize(temperature=mean(as.numeric(TAVE)))

#K1_meta<-merge(K1_meta,df_temp_ave_year, by=c("year"))

#precipitation: load data, calculate annual precip, merge with main dataset
#df_ppt <- read.csv("Precipitation_1982_2023.csv")%>%
  #filter(ppt!=".")
#df_ppt[is.na(df_ppt)] <- 0

  #Convert the date column to Date type, then extract year and day of year
#df_ppt$RecDate<- as.Date(df_ppt$RecDate, format = "%m/%d/%Y")
#df_ppt$year <- year(df_ppt$RecDate)

  #average across year
#df_ppt_ave_year <- df_ppt %>% 
  #group_by(year) %>%
  #summarize(precipitation=sum(as.numeric(ppt)))

  #merge with main dataset
#K1_meta<-merge(K1_meta,df_ppt_ave_year, by=c("year"))

#growing_precipitation: calculate growing season precip, merge with main dataset
#df_ppt$doy <- strftime(df_ppt$RecDate, format = "%j")
#df_ppt$doy<-as.numeric(df_ppt$doy)

  #filter dataset based on growing season defined for KNZ as 85-278 in Robinson etal 2012 
#df_ppt_gs<-filter(df_ppt,doy>=85&doy<=278)

#average across year
#df_ppt_ave_year_gs <- df_ppt_gs %>% 
  #group_by(year) %>%
  #summarize(growing_precipitation=sum(as.numeric(ppt)))

#merge with main dataset
#K1_meta<-merge(K1_meta,df_ppt_ave_year_gs, by=c("year"))

#load in nitrogen treatment info then merge datasets
#K1_N<-read.csv("dropbox_plotlist_trts_copy.csv")%>%
  #rename(higher_order_organization=block, nitrogen_amount=nitrogen) #drop unneeded columns
#loading directly from google drive
K1_N<-read.csv(file.path(L0_dir,"KNZ/dropbox_plotlist_trts_copy.csv"))%>%
  rename(higher_order_organization=block, nitrogen_amount=nitrogen) #drop unneeded columns


K1_meta<-merge(K1_meta,K1_N, by=c("plot","higher_order_organization"))

#treatment:
K1_meta$treatment<-ifelse(K1_meta$nitrogen_amount=="0","control","treatment")

#nutrients_added:
K1_meta$nutrients_added<-ifelse(K1_meta$nitrogen_amount=="0","no_fertilizer","N")

#disturbance:
K1_meta$disturbance<-"undisturbed"

#grazing:
K1_meta$grazing<-"ungrazed"

#fire_frequency:
K1_meta$fire_frequency<-1

#time_since_fire: 
K1_meta$time_since_fire<-0

#Source:
K1_meta$source<-"personal_most_recent_version_only_portion_on_Konza_site"

#treatment_comment:
K1_meta$treatment_comment<-"does_not_apply"

#diversity_manipulated
K1_meta$diversity_manipulated<-"naturally_assembled"

#write cleaned document
#write.csv(K1_meta, "K3_NGE01_Metadata.csv")
```
#Rachael's code for VI data-edited and uploaded by Joshua
```{r}
# watershed, experiment, block, plot

#VI_11 <- read.csv("VIR011_raw.csv", stringsAsFactors = F)
#VI_12 <- read.csv("VIR012.csv", stringsAsFactors = F)
#VI_2023 <- read.csv("VI_2023_scomp_clean.csv", stringsAsFactors = F)
#Precipitation <- read.csv("Precipitation_1982_2023.csv", stringsAsFactors = F)
#Temp <- read.csv("Temperature_1982_2023.csv", stringsAsFactors = F)

#loading data from gogle drive
VI_11<-read.csv(file.path(L0_dir, "KNZ/B1_VIR011_Sppcomp.csv"), stringsAsFactors = F)
VI_12<-read.csv(file.path(L0_dir, "KNZ/B2_VIR012_Biomass.csv"), stringsAsFactors = F)

#cleaning biomass data
VI_biomass <- VI_12 %>% 
  mutate(plot_id = paste(Block, Plot, SubPlot, sep = "_")) %>% 
  select(-Pryrdead) %>% 
  group_by(RecYear, Lvgrass, Forbs, Woody, plot_id) %>% 
  mutate(plot_biomass = Lvgrass + Forbs + Woody) %>% 
  ungroup() %>% 
  select(-Datacode, -Rectype, -Lvgrass, -Forbs, -Woody, -Comments) %>% 
  rename(year = RecYear) %>% 
  mutate(site = "KNZ") %>% #adding site
  mutate(watershed = "2c") %>% 
  mutate(experiment = "VI") %>% 
  mutate(higher_order_organization = paste(watershed, experiment, Block, Plot, SubPlot, sep = "_"))
  
VI_tidy <- VI_11 %>% 
  mutate(RecSeason = ifelse(RecSeason %in% "fall", "Fall", RecSeason)) %>% 
  mutate(RecSeason = ifelse(RecSeason %in% "spring", "Spring", RecSeason)) %>% 
  mutate(species = paste(Ab_genus, AB_species, sep = "_")) %>% 
  mutate(plot_id = paste(Block, Plot, Subplot, sep = "_"))

VI_tidy$species = toupper(VI_tidy$species) #names not entered consistently

#treatment key
trt_key_VI <- data.frame(Plot=levels(factor(VI_tidy$Plot)),trt_combo=
                           c("NCI","NCI","CCC","NCC", "CCI", "NCC", "CCC", "CCI", 
                             "CCI", "NCI", "NCC", "NCI", "CCC", "CCI", "NCC", "CCC",
                             "NCI", "CCI", "CCC", "NCI", "CCC", "CCI", "NCC", "NCC")) %>% 
  mutate(Plot = as.integer(Plot))

VI_tidier <- VI_tidy %>% #second round - cleaning up entry errors and unneeded data
  mutate(RecSeason = ifelse(RecSeason %in% "fall", "Fall", RecSeason)) %>% 
  mutate(RecSeason = ifelse(RecSeason %in% "spring", "Spring", RecSeason)) %>% 
  mutate(species = paste(Ab_genus, AB_species, sep = "_")) %>% 
  left_join(trt_key_VI, by = "Plot")%>%
  filter(!species == "NA_NA") %>% 
  filter(!species == "BARE_GROUND") %>% 
  filter(!species == "LITTER_") %>% 
  filter(!species == "DUNG_") %>% 
  mutate(species = ifelse(species %in% "DICHANTHELIUM_OLIGOSANTHES", "DICANTHELIUM_OLIGOSANTHES", species)) %>%
  mutate(species = ifelse(species %in% "SCHIZACHYRIUM_SCOPARIUS", "SCHIZACHYRIUM_SCOPARIUM", species)) %>%
  mutate(species = ifelse(species %in% "CYPERUS_SPP.", "CYPERUS_SPP", species)) %>% 
  mutate(site = "KNZ") %>% #adding site name
  rename(year = RecYear) %>% 
  rename(abundance = Cover) %>% 
  select(-Comments, - SpeCode, -Ab_genus, -AB_species)

as.integer(VI_tidier$year)

VI_rel_abundance <- VI_tidier %>% 
  group_by(site, year, plot_id, species) %>% 
  summarize(ab_max = max(abundance)) %>% 
  mutate(relative_abundance = ab_max / sum(ab_max) * 100) %>% 
  ungroup()
  
commMetrics <- community_structure(VI_rel_abundance, abundance.var='relative_abundance', replicate.var='plot_id', time.var = 'year') %>% 
  rename(plot = "plot_id")
commMetrics2 <- community_structure(VI_rel_abundance, abundance.var='relative_abundance', replicate.var='plot_id', time.var = 'year') %>% 
  rename(plot = "plot_id")

commMetricsBio <- commMetrics2 

####final Species comp datasheet####
spp_comp <- VI_rel_abundance %>% 
  rename(plot = plot_id) %>% #block, plot, subplot
  mutate(watershed = "2c") %>% #adding watershed
  mutate(higher_order_organization = paste(site, "VI", watershed, sep = "_")) %>% #site, experiment, watershed
  mutate(uniqueid = paste(higher_order_organization, plot, sep = "_")) %>% 
  rename(abundance = ab_max) %>% 
  mutate(original_measurement_unit = "%cover") %>%
  mutate(relative_abundance = relative_abundance/100) %>% #dividing by 100
  select(year, site, plot, higher_order_organization, uniqueid, species, abundance, relative_abundance, original_measurement_unit) #ordering columns

burn_y <- c(2009, 2011, 2013, 2015, 2017, 2021) #adding in burn years

trt_key_VI <- data.frame(Plot=levels(factor(VI_tidy$Plot)),trt_combo=
                           c("NCI","NCI","CCC","NCC", "CCI", "NCC", "CCC", "CCI", 
                             "CCI", "NCI", "NCC", "NCI", "CCC", "CCI", "NCC", "CCC",
                             "NCI", "CCI", "CCC", "NCI", "CCC", "CCI", "NCC", "NCC")) %>% 
  mutate(Plot = as.factor(Plot)) #plot and treatment key
nutrient_key <- data.frame(Plot=levels(factor(VI_tidy$Plot)), nutrients=
                           c("NPK+","NPK+","no_fertilizer","NPK+", "no_fertilizer", "NPK+", "no_fertilizer", "no_fertilizer", "no_fertilizer", "NPK+", "NPK+", "NPK+", "no_fertilizer", "no_fertilizer", "NPK+", "no_fertilizer","NPK+", "no_fertilizer", "no_fertilizer", "NPK+", "no_fertilizer", "no_fertilizer", "NPK+", "NPK+")) %>% 
  mutate(Plot = as.factor(Plot)) #plot and treatment key

keys_together <- nutrient_key %>% 
  left_join(trt_key_VI, by = "Plot")

#Hey Rachael, not sure what is going on here! I will just comment them out
#data <- data %>%
 # mutate(middle_number = str_extract(code, "(?<=\\_)[0-9]+(?=\\_)"))

biomass <- VI_12 %>% 
  # mutate(plot = paste(Block, Plot, SubPlot, sep = "_")) %>% 
  select(-Comments, -Pryrdead) %>% 
  mutate(plot_biomass = (Lvgrass + Forbs + Woody)*10) %>% 
  rename(year = RecYear) %>% 
  # select(year, plot, Plot, plot_biomass) %>% 
  group_by(year, Block, Plot) %>% 
  summarize(total_biomass = sum(plot_biomass)) %>% 
  rename(block = Block) %>% 
  rename(plot = Plot) %>% 
  ungroup()
#replacing missing value
biomass$total_biomass[biomass$total_biomass == -29134.0] <- NA
  # separate(biomass, into = c("Block", "Plot", "Subplot"), sep = "_")

  # mutate(block_subplot = str_extract(biomass, "^[^_]+_[^_]+")) #separating block and subplot

sppBio <- spp_comp %>%
  separate(plot, into = c("block", "plot", "subplot"), sep = "_") %>% 
  mutate(block = as.integer(block), plot = as.integer(plot)) %>% 
  left_join(biomass, by = c("year", "block", "plot")) %>% 
  rename(plot_biomass = total_biomass) %>% 
  mutate(plot = paste(block, plot, subplot, sep = "_"))

richBio <- sppBio %>%
  left_join(commMetricsBio, by = c("year", "plot"))

plotyear <- richBio %>% 
  #left_join(ave_selectedTemp, by = "year") %>% 
  mutate(fire_frequency = 2) %>% 
  mutate(treatment_comment = "cessation following 2018") %>% 
    mutate(time_since_fire = ifelse(year %in% burn_y, "0", "1")) %>% 
  mutate(source = "B1_VIR011_Sppcomp.csv") %>% 
  mutate(Plot = str_extract(plot, "(?<=\\_)[0-9]+(?=\\_)")) %>% #pulling out plot to join dataset of treatment key
  left_join(keys_together, by = "Plot") %>% 
  rename(evenness = Evar)
  
plotyear_treat <- plotyear %>%
  mutate(trt_combo = ifelse(trt_combo == "NCI", "NPK+ & insecticide",
                            ifelse(trt_combo == "CCC", "control",
                                   ifelse(trt_combo == "NCC", "NPK+", 
                                          ifelse(trt_combo == "CCI", "insecticide", as.character(trt_combo)))))) %>%
  rename(treatment = trt_combo) %>%
  mutate(measurement_scale_biomass = "0.2",
         grazing = "ungrazed",
         disturbance = ifelse(nutrients == "no_fertilizer", "undisturbed", "disturbed")) %>% 
  mutate(diversity_manipulated = "naturally_assembled") %>% 
  rename(nutrients_added = nutrients) %>% 
  mutate(measurement_scale_cover = "1")


####final full datasheet#####

final <- plotyear_treat %>% #ordering columns and checking presence
  select(year, site, plot, higher_order_organization, uniqueid, treatment, nutrients_added, disturbance, grazing, fire_frequency, time_since_fire, source, treatment_comment, diversity_manipulated, plot_biomass, measurement_scale_biomass, richness, evenness, measurement_scale_cover, abundance, relative_abundance, species)

#separate metadata deom biomass and species abundance data
#metadata
B1_B2_metadata<-final%>%
  select(year,site,plot,higher_order_organization,uniqueid,treatment,nutrients_added, disturbance, grazing, fire_frequency, time_since_fire, source, treatment_comment, diversity_manipulated)%>%
  distinct()
#plot level metrics with biomass
B2_plot_biomass<-final%>%
  select(year,site,plot,higher_order_organization,uniqueid, plot_biomass, measurement_scale_biomass,measurement_scale_cover)%>%
  distinct()
#spp comp data
B1_sppcomp<-final%>%
  select(year,site,plot,higher_order_organization,uniqueid, species, relative_abundance,abundance)%>%
  mutate(original_measurement_unit="%cover")
```


#precipitation and temperature data-Joshua (modified from Mary's and Smriti's code)
```{r}
 
df_ppt <- read.csv(file.path(L0_dir, "KNZ/Precipitation_1982_2023.csv"), stringsAsFactors = FALSE)
df_temp <- read.csv(file.path(L0_dir, "KNZ/Temperature_1982_2023.csv"), stringsAsFactors = FALSE)
# Convert the date column to Date type 
df_ppt$RecDate<- as.Date(df_ppt$RecDate, format = "%m/%d/%Y")
# Extract the year from the date
df_ppt$year <- year(df_ppt$RecDate)

# Summarizing temperature data
# Averaging across months
df_temp_ave_month <- df_temp %>% 
  group_by(RECYEAR, RECMONTH) %>%
  summarize(mean=mean(as.numeric(TAVE),na.rm=T))

# Averaging across years
df_temp_ave_year <- df_temp %>% 
  group_by(RECYEAR) %>%
  summarize(temperature=mean(as.numeric(TAVE), na.rm=T))%>%
  rename(year=RECYEAR)

#average across year
df_ppt_ave_year <- df_ppt %>% 
  group_by(year) %>%
  summarize(precipitation=sum(as.numeric(ppt),na.rm=T))

#growing_precipitation: calculate growing season precip, merge with main dataset
df_ppt$doy <- strftime(df_ppt$RecDate, format = "%j")
df_ppt$doy<-as.numeric(df_ppt$doy)

  #filter dataset based on growing season defined for KNZ as 85-278 in Robinson etal 2012 
df_ppt_gs<-filter(df_ppt,doy>=85&doy<=278)

#average across year
df_ppt_ave_year_gs <- df_ppt_gs %>% 
  group_by(year) %>%
  summarize(growing_precipitation=sum(as.numeric(ppt),na.rm=T))

weather_df<-df_ppt_ave_year%>%
  left_join(df_ppt_ave_year_gs, by="year")%>%
  left_join(df_temp_ave_year, by="year")

```

#combining all Konza data-Joshua
```{r}
#some extra mop up for species level data
df_I1_KNZ.clean<-df_I1_KNZ.clean%>%
  mutate(relative_abundance=relative_abundance/100)
df_C1_KNZ.cleanest<-df_C1_KNZ.cleanest%>%
  rename(uniqueid=unique_id)%>% mutate(site="KNZ")
df_C1_KNZ.cleanest<-df_C1_KNZ.cleanest%>%
  mutate(relative_abundance=relative_abundance/100)
RaMPs_PlantCommunityComposition<-RaMPs_PlantCommunityComposition%>%
  mutate(uniqueid=uniqueID)
df_A1_KNZ.clean<-df_A1_KNZ.clean%>%
  mutate(relative_abundance=relative_abundance/100)
df_E1_KNZ_species_level$plot<-as.factor(df_E1_KNZ_species_level$plot)
K1_spp$plot<-as.factor(K1_spp$plot)
df_C1_KNZ.cleanest$plot<-as.factor(df_C1_KNZ.cleanest$plot)
df_I1_KNZ.clean$plot<-as.factor(df_I1_KNZ.clean$plot)
df_J2_KNZ.clean.richness.evenness$plot<-as.factor(df_J2_KNZ.clean.richness.evenness$plot)
df_A1_KNZ.clean$plot=as.factor(df_A1_KNZ.clean$plot)
df_C1_KNZ.cleanest$measurement_scale_cover=as.factor(df_C1_KNZ.cleanest$measurement_scale_cover)
RaMPs_PlantCommunityComposition$measurement_scale_cover<-as.factor(RaMPs_PlantCommunityComposition$measurement_scale_cover)

#combining species level data set
KNZ_specieslevel_abundance<-df_E1_KNZ_species_level%>%
  select(-1:-2,-5,-6,-9,-15)%>%
  bind_rows(K1_spp,df_C1_KNZ.cleanest,df_I1_KNZ.clean,df_J2_KNZ.clean.richness.evenness,RaMPs_PlantCommunityComposition)%>%
  select(1:9)%>%
  bind_rows(df_A1_KNZ.clean)%>%
  select(1:9)%>%
  bind_rows(B1_sppcomp)
summary(KNZ_specieslevel_abundance$uniqueid)

  
#upload to google drive
write.csv(KNZ_specieslevel_abundance,file.path(L1_dir,"/KNZ_specieslevel_abundance.csv"))

#data mop up for plot biomass
df_E1_E2_KNZ_clean_plot_metrics$plot<-as.factor(df_E1_E2_KNZ_clean_plot_metrics$plot)
K1_mass$plot<-as.factor(K1_mass$plot)
df_C2_KNZ_cleanest$plot<-as.factor(df_C2_KNZ_cleanest$plot)
df_I1_I2_KNZ.clean$measurement_scale_biomass=as.integer(df_I1_I2_KNZ.clean$measurement_scale_biomass)
df_I1_I2_KNZ.clean$measurement_scale_cover=as.integer(df_I1_I2_KNZ.clean$measurement_scale_cover)
df_I1_I2_KNZ.clean<-df_I1_I2_KNZ.clean%>%
  mutate(plot_biomass=total)
df_I1_I2_KNZ.clean$block=as.factor(df_I1_I2_KNZ.clean$block)
RaMPs_ANPP<-RaMPs_ANPP%>%
  mutate(uniqueid=uniqueID)
B2_plot_biomass$measurement_scale_biomass=as.numeric(B2_plot_biomass$measurement_scale_biomass)
B2_plot_biomass$measurement_scale_cover=as.numeric(B2_plot_biomass$measurement_scale_cover)
df_C2_KNZ_cleanest$measurement_scale_biomass<-as.numeric(df_C2_KNZ_cleanest$measurement_scale_biomass)
#combining konza plot biomass data
KNZ_plotlevel_metrics<-df_E1_E2_KNZ_clean_plot_metrics%>%
  select(-1,-2,-5)%>%
  bind_rows(K1_mass,df_C2_KNZ_cleanest,df_A1_A2_KNZ.clean,df_J2_KNZ.clean.richness.evenness,df_I1_I2_KNZ.clean,RaMPs_ANPP)%>%
  select(1:12)%>%
  bind_rows(B2_plot_biomass)

summary(KNZ_plotlevel_metrics)

#upload to google drive
write.csv(KNZ_plotlevel_metrics,file.path(L1_dir,"/KNZ_plotlevel_metrics.csv"))

#mop up of metadata
df_E1_E2_metadata$plot=as.factor(df_E1_E2_metadata$plot)
K1_meta$plot=as.factor(K1_meta$plot)
A1_A2_metadata$plot<-as.factor(A1_A2_metadata$plot)
B1_B2_metadata$plot=as.factor(B1_B2_metadata$plot)
B1_B2_metadata$time_since_fire=as.integer(B1_B2_metadata$time_since_fire)
C1_Meta$plot<-as.factor(C1_Meta$plot)
C1_Meta<-C1_Meta%>%select(-measurement_scale_biomass)
df_I1_I2_KNZ.clean$measurement_scale_biomass<-as.factor(df_I1_I2_KNZ.clean$measurement_scale_biomass)
RaMPs_PlantCommunityComposition$measurement_scale_cover<-as.integer(RaMPs_PlantCommunityComposition$measurement_scale_cover)
RaMPs_PlantCommunityComposition$measurement_scale_biomass<-as.factor(RaMPs_PlantCommunityComposition$measurement_scale_biomass)
#combine Konza metadata


KNZ_metadata<-df_E1_E2_metadata%>%
  select(-2,-5)%>%
  bind_rows(K1_meta,df_J2_KNZ.clean.richness.evenness,C1_Meta,A1_A2_metadata,df_I1_I2_KNZ.clean,RaMPs_PlantCommunityComposition)%>%
  select(1:18)%>%
  distinct()%>%
  bind_rows(B1_B2_metadata)%>%
  left_join(weather_df)
#use ambient as control for ramps

summary(KNZ_metadata)

#upload to google drive
write.csv(KNZ_metadata,file.path(L1_dir,"/KNZ_metadata.csv"))


```
