---
title: "KNZ_L0_data_wrangling"
authors: Smriti Pehim Limbu, Joshua Ajowele
Collaborators: Grassland Rocks working group
date: "2023-12-11" Last Modified: "Jan 12, 2025"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##package upload
```{r}
install.packages(pacman)
library(pacman)
pacman::p_load(readr, ggplot2, dplyr, tidyverse, gtools, lubridate, codyn) #lubridate is to change the date format

```

##set working directory
```{r}
L0_dir <- Sys.getenv("L0DIR")
L1_dir <- Sys.getenv("L1DIR")
L2_dir <- Sys.getenv("L2DIR")
list.files(L0_dir)
```

##Load files, more needs to be loaded

```{r}
#Joshua's directory
#df_E1_KNZ<-read.csv("C:/Users/JAAJOWELE/Downloads/E1_PPL011_Sppcomp.csv")
#df_E2_KNZ<-read.csv("C:/Users/JAAJOWELE/Downloads/E2_PPL012_Biomass.csv")
#loading from google drive-Joshua
df_E1_KNZ<-read.csv(file.path(L0_dir, "KNZ/E1_PPL011_Sppcomp.csv"))
df_E2_KNZ<-read.csv(file.path(L0_dir, "KNZ/E2_PPL012_Biomass.csv"))
df_J1_KNZ <- read.csv(file.path(L0_dir, "KNZ/J1_CEE012_Sppcomp.csv"), stringsAsFactors = FALSE)
df_J2_KNZ <- read.csv(file.path(L0_dir, "KNZ/J2_CEE014_Biomass.csv"), stringsAsFactors = FALSE)


```




#Cleaning CEE data J1 and J2 - Smriti

```{r}

#renaming variables

df_J1_KNZ.clean <- df_J1_KNZ %>% rename(year = Year, species = Spnum2, abundance=Cover)

#adding site name, watershed name, blocks, and higher_order_organization

df_J2_KNZ.clean <- df_J2_KNZ %>% rename(year = Year)  %>% mutate(site = "KNZ") %>% mutate(watershed="HQ") %>% mutate(Block =case_when(Plot%in% c(101, 102, 103, 104, 105, 106, 107, 108, 109, 110)~"1", Plot%in% c(101, 102, 103, 104, 105, 106, 107, 108, 109, 110)~"1",Plot%in% c(201, 202,203, 204, 205, 206, 207, 208, 209, 210)~"2", Plot%in% c(301, 302, 303, 304, 305, 306, 307, 308, 309, 310)~"3",Plot%in% c(401, 402, 403, 404, 405, 406, 407, 408, 409, 410)~"4")) %>%  unite(higher_order_organization,site, watershed,Block,Plot, sep ="_", remove=FALSE)


#calculate richness and evenness

df_J1_richness_evenness <- community_structure(df_J1_KNZ.clean, time.var = "year", replicate.var = "Plot", abundance.var = "abundance", metric="SimpsonEvenness")

#add richness and evenness to the biomass data

df_J2_KNZ.clean.richness.evenness <- left_join (df_J2_KNZ.clean, df_J1_richness_evenness, by = c("year", "Plot"))%>%
  rename(plot_biomass=Total)%>%
  rename(plot=Plot)%>%
  rename(evenness=SimpsonEvenness)


```

#cleaning data E1 and E2 - Joshua
```{r}
#check each column for uniqueness for E1 and E2 data
unique(df_E1_KNZ$RecYear)#2020 missing due to covid
unique(df_E2_KNZ$RecYear)#2020 data present
unique(df_E1_KNZ$Treatment)#looks good, 8 treatments
unique(df_E2_KNZ$Treatment)#looks good, 8 treatment
unique(df_E1_KNZ$PlotID)#48 plots
unique(df_E2_KNZ$PlotID)#48 plots

#clean and wrangle sp comp data
df_E1_KNZ_clean_sppcomp<-df_E1_KNZ%>%
  rename(year=RecYear)%>%
  unite(species_name,Genus,Species, sep = "_")%>%
#unique(df_E1_KNZ_clean$species_name)#no obvious duplicate 
  group_by(year, PlotID, Treatment)%>%
  mutate(total_abundance=sum(Abundance))%>%
  group_by(year, PlotID, Treatment, species_name)%>%
  mutate(relative_abundance=(Abundance/total_abundance))%>%
  ungroup()%>%
  rename(abundance=Abundance,
         plot=PlotID,species=species_name)%>%
  mutate(original_measurement_unit="%cover",
         site="KNZ",
         higher_order_organization=paste(site,"PPLOT","2C",sep="_"),
         uniqueid=paste(higher_order_organization,plot,sep="_"))%>%
  #create unique identifier for codyn package for community metric
  mutate(PlotID=paste(plot,Treatment, sep="_"))#ready for richness/diversity calculation with codyn package

#ready to join with other Konza species comp data
df_E1_KNZ_species_level<-df_E1_KNZ_clean_sppcomp
  

#calculate diversity/richness/evenness
#I used Evar for evenness because it is independent of species richness
E1_richness<-df_E1_KNZ_clean_sppcomp%>%
  community_diversity(time.var="year",abundance.var="relative_abundance",
                      replicate.var="PlotID",metric = "Shannon")
E1_diversity<-df_E1_KNZ_clean_sppcomp%>%
  #calculates richness and evenness as Evar
  community_structure(time.var="year",abundance.var="relative_abundance",
                      replicate.var="PlotID")%>%
  left_join(E1_richness, by=c("year","PlotID"))%>%
  separate_wider_delim(PlotID,"_", names=c("plot","Treatment"))%>%
  filter(year!=2002)
#convert to integer to allow joining with biomass data
E1_diversity$plot=as.integer(E1_diversity$plot)

#clean and wrangle complementary biomass data and join with spcomp data

#create a treatment key
treatment_key=tibble(Treatment=levels(factor(df_E2_KNZ$Treatment)),                        treatment_key=c("control","N0P2.5","N0P5","N0P10",
                                    "N10P0","N10P2.5","N10P5","N10P10"))

#clean biomass data and join with richness data
df_E1_E2_KNZ_clean_plot_metrics<-df_E2_KNZ%>%
  rename(year=RecYear, plot_biomass=ANPP,plot=PlotID)%>%
  mutate(site="KNZ")%>%
  left_join(E1_diversity, by=c("year","Treatment", "plot"))%>%
  left_join(treatment_key, by="Treatment")%>%
  rename(treatment=treatment_key, evenness=Evar)%>%
  mutate(site="KNZ",
         higher_order_organization=paste(site,"PPLOT","2C",sep="_"),
         uniqueid=paste(higher_order_organization,plot,sep="_"),
         measurement_scale_biomass=0.1,
         measurement_scale_cover=1)%>%
  filter(year!=2002)
#ready to merge with other plot metric data set

#create metadata 
#create metadata keys
treatment_key_metadata=tibble(treatment=levels(factor(df_E1_E2_KNZ_clean_plot_metrics$treatment)),               nutrients_added=c("no_fertilizer","P","P","P","N","NP","NP","NP"),
                              nitrogen_amount=c(0,0,0,0,10,10,10,10),
                              phosphorus_amount=c(0,10,2.5,5,0,10,2.5,5),
                              disturbance="undisturbed",
                              watershed="2C",
                              treatment_comment="NA",
                              grazing="ungrazed",
                              fire_frequency=2,
                              diversity_manipulated="naturally_assembled",)
#key for time since fire
time_since_fire_key=tibble(year=levels(factor(df_E1_E2_KNZ_clean_plot_metrics$year)),                        time_since_fire=c(0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0)                                     )
#convert year to integer
time_since_fire_key$year=as.integer(time_since_fire_key$year)
df_E1_E2_metadata<-df_E1_E2_KNZ_clean_plot_metrics%>%
  select(1:5,7,11:13)%>%
  left_join(treatment_key_metadata, by="treatment")%>%
  rename(source=DataCode)%>%
  left_join(time_since_fire_key, by="year")%>%
  #2002 is pretreatment data so easier to remove from the rest of the data
  filter(year!=2002)
#ready to merge with other Konza metadata


```

#Cleaning data C1 & C2 - Alex's code (uploaded and edited by Joshua)
```{r}


##Species comp
df_C1_KNZ<-read.csv(file.path(L0_dir, "KNZ/C1_WAT012_Sppcomp.csv"))
df_C2_KNZ<-read.csv(file.path(L0_dir, "KNZ/C2_WAT013_Biomass.csv"))

#Merging Genus & Species columns
df_C1_KNZ$species <- paste(df_C1_KNZ$Genus,df_C1_KNZ$Species)
#Removing unnecessary columns
df_C1_KNZ = df_C1_KNZ %>%
  select(-c("Rectype","Genus","Species"))%>%
  #removing these years since there was a reversal
  filter(RecYear%in%c(1991:2016))
#convert cover class to percentage cover
cover_class_key<-data.frame(Cover=c(1:7),
                            abundance=c(0.5,3,15,37.5,62.5,85,97.5))
df_C1_KNZ<-df_C1_KNZ%>%
  left_join(cover_class_key, by="Cover") 
#Renaming columns
df_C1_KNZ.clean <- df_C1_KNZ %>% rename(year = RecYear, treatment = Trt, transect = Transect, plot = Plot, species_code = Spcode)
#Adding columns
df_C1_KNZ.clean <- df_C1_KNZ.clean %>% 
  mutate(site = "KNZ")
#Checking columns for uniqueness
unique(df_C1_KNZ.clean$year) #1991-2016
unique(df_C1_KNZ.clean$treatment) #Two treatments (a & i)
unique(df_C1_KNZ.clean$plot) #30 plots (no #9?, added plots in 1993)
unique(df_C1_KNZ.clean$transect) #Four transects
## Must consider treatment reversal for this experiment ##

unique(df_C1_KNZ.clean$treatment)
#clean and wrangle spp comp data
df_C1_KNZ.clean<-df_C1_KNZ.clean%>%
  group_by(year, transect,plot, treatment)%>%
  mutate(total_abundance=sum(abundance))%>%
  group_by(year, transect,plot, treatment, species)%>%
  mutate(relative_abundance=(abundance/total_abundance))%>%
  ungroup()%>%
  #create unique identifier for codyn package for community metric
  unite(plot_transect_trt, plot,transect, treatment, sep="_", remove=FALSE)

#calculate diversity/richness/evenness
C1_richness<-df_C1_KNZ.clean%>%
  community_diversity(time.var="year",abundance.var="relative_abundance",
                      replicate.var="plot_transect_trt",metric = "Shannon")
C1_diversity<-df_C1_KNZ.clean%>%
  #calculates richness and evenness as Evar
  community_structure(time.var="year",abundance.var="relative_abundance",
                      replicate.var="plot_transect_trt")%>%
  left_join(C1_richness, by=c("year","plot_transect_trt"))%>%
  separate_wider_delim(plot_transect_trt,"_", names=c("plot", "transect","treatment"))
#convert to integer to allow joining with biomass data
C1_diversity$plot=as.integer(C1_diversity$plot)


df_C1_KNZ.cleanest <- df_C1_KNZ.clean %>%
  mutate(method="sorted_to_species",
         experiment="WAT01",
         cover_method = "physical_quantity",
         area_sampled_bio = 10,
         area_sampled_cover = 0.1) %>%
  unite(higher_order_organization,site,experiment,plot, sep ="_", remove=FALSE) %>%
  unite(uniqueid,site,experiment,plot,treatment, sep ="_", remove=FALSE)%>%
  select(year,plot,uniqueid,species,abundance,relative_abundance,higher_order_organization)%>%
  mutate(original_measurement_unit="%cover")
  

#Writing sppcomp dataset to upload to L1 folder
#write.csv(df_C1_KNZ.cleanest,"C:\\Users\\jasig\\Downloads\\df_C1_KNZ.cleanest.csv", row.names=FALSE)


##Biomass data
df_C2_KNZ.cleaner <- df_C2_KNZ %>%
  select(-c("RECMONTH","COMMENTS")) %>%
  rename(DataCode=DATACODE, year=RECYEAR, watershed=WATERSHED, treatment=TRANSECT, plot=PLOT, replicate=REPLICATE, livegrass=LIVEGRASS, forbs=FORBS, woody=WOODY, currentdead=CURRENTDEAD)
#Creating ANPP column
df_C2_KNZ.cleaner$livegrass = as.numeric(df_C2_KNZ.cleaner$livegrass)
df_C2_KNZ.cleaner$forbs = as.numeric(df_C2_KNZ.cleaner$forbs)
df_C2_KNZ.cleaner$woody = as.numeric(df_C2_KNZ.cleaner$woody)
df_C2_KNZ.cleaner$currentdead=as.numeric(df_C2_KNZ.cleaner$currentdead)
#turn na into zero
df_C2_KNZ.cleaner$currentdead[is.na(df_C2_KNZ.cleaner$currentdead)]<-0
df_C2_KNZ.cleaner$livegrass[is.na(df_C2_KNZ.cleaner$livegrass)]<-0
df_C2_KNZ.cleaner$forbs[is.na(df_C2_KNZ.cleaner$forbs)]<-0
df_C2_KNZ.cleaner$woody[is.na(df_C2_KNZ.cleaner$woody)]<-0

df_C2_KNZ.cleaner$total_biomass = df_C2_KNZ.cleaner$livegrass + df_C2_KNZ.cleaner$forbs + df_C2_KNZ.cleaner$woody+df_C2_KNZ.cleaner$currentdead


#Changing treatment naming conventions to match species comp
df_C2_KNZ.cleaner$treatment[df_C2_KNZ.cleaner$treatment=="c"]<-"a"
df_C2_KNZ.cleaner$treatment[df_C2_KNZ.cleaner$treatment=="ni"]<-"a"
#Calculating plot_biomass and more
df_C2_KNZ.clean <- df_C2_KNZ.cleaner %>%
  filter(year%in%c(1991:2016))%>%
  group_by(year,plot,treatment) %>%
  mutate(plot_biomass = mean(total_biomass, na.rm=T))%>%
  mutate(site = "KNZ") %>%
#create unique identifier to consolidate reps
  unite(plot_trt, plot, treatment, sep="_", remove=FALSE)%>%
  unite(higher_order_organization,site,DataCode,plot, sep ="_", remove=FALSE)%>%
  mutate(uniqueid = paste(site,DataCode,plot_trt, sep ="_"),#Adding column to make it possible to merge with diversity df
         year_plot_trt = paste(year, plot_trt, sep="_"))%>%
  select(year,site,plot,higher_order_organization,uniqueid,plot_biomass,year_plot_trt)%>%
  distinct()
  





  
#Merging with diversity metrics
df_C2_KNZ_cleanest <- df_C2_KNZ.clean %>%
  mutate(plot_biomass=plot_biomass*10)%>%
  mutate(measurement_scale_biomass="0.1",
         measurement_scale_cover="10",
         original_measurement_unit="%cover")%>%
  select(-year_plot_trt)%>%
  mutate(treatment=case_when(treatment=="a"~"control",
                             treatment=="i"~"irrigated"))
  




#metadata
#Drop unnecessary columns
C1_Meta<-df_C2_KNZ_cleanest %>%
  dplyr::select(-plot_biomass) #drop unneeded columns







#nutrients_added:
C1_Meta$nutrients_added<-"no_fertilizer"

#disturbance:
C1_Meta$disturbance<-"undisturbed"

#grazing:
C1_Meta$grazing<-"ungrazed"

#fire_frequency:
C1_Meta$fire_frequency<-1

#time_since_fire: 
C1_Meta$time_since_fire<-0

#Source:
C1_Meta$source<-"WAT01"

#treatment_comment:
C1_Meta$treatment_comment<-"irrigation lines shifted in 2017"

#diversity_manipulated
C1_Meta$diversity_manipulated<-"naturally_assembled"





```


# Cleaning data D1 and D2 - Matt (uploaded and edited by Joshua)
```{r}

## bring in RaMPs data
# ramps <- read.csv("D1_D2_RMP011_Sppcomp_Biomass .csv",header = TRUE, sep = ",") # NOTICE there is a space before the .csv
#Note from Maya: I am going to read in data from the shared Google drive instead

ramps <- read.csv(file.path(L0_dir, "KNZ/D1_D2_RMP011_Sppcomp_Biomass .csv"), header = TRUE, sep = ",", stringsAsFactors = FALSE) # NOTICE there is a space before the .csv

#ramps$RecYear <- as.factor(ramps$RecYear)
ramps$season <- as.factor(ramps$season)
ramps$RampNo <- as.factor(ramps$RampNo)
ramps$Species <- as.factor(ramps$Species)


## bring in RaMPs data
# ramps <- read.csv("D1_D2_RMP011_Sppcomp_Biomass .csv",header = TRUE, sep = ",") # NOTICE there is a space before the .csv
#Note from Maya: I am going to read in data from the shared Google drive instead


##### ANPP #####
RaMPs_ANPP_working <- ramps %>% 
  filter(season == "F") %>% 
  mutate(A_g_m2 = A*10,
         B_g_m2 = B*10,
         C_g_m2 = C*10,
         D_g_m2 = D*10) %>% 
  group_by(RecYear, season, RampNo, Species) %>% 
  summarize(A_g_m2 = mean(A_g_m2),
            B_g_m2 = mean(B_g_m2),
            C_g_m2 = mean(C_g_m2),
            D_g_m2 = mean(D_g_m2)) %>% 
  ungroup() %>% 
  group_by(RecYear, RampNo) %>% 
  summarize(A_ANPP = sum(A_g_m2),
            B_ANPP = sum(B_g_m2),
            C_ANPP = sum(C_g_m2),
            D_ANPP = sum(D_g_m2)) %>% 
  tidyr::gather(key="plot", value="plot_biomass", A_ANPP, B_ANPP, C_ANPP, D_ANPP) %>% 
  mutate(plot = plyr::revalue(plot, c("A_ANPP" = "A",
                                      "B_ANPP" = "B",
                                      "C_ANPP" = "C",
                                      "D_ANPP" = "D")))

ambient_ramps <- c(3, 4, 6, 7, 11, 15)
altered_ramps <- c(2,5,9, 10, 12, 13)
control_ramps <- c(1, 8, 14)

levels(as.factor(RaMPs_ANPP_working$RampNo))
class(RaMPs_ANPP_working$RampNo)


RaMPs_ANPP <- RaMPs_ANPP_working %>% 
  dplyr::rename(year = RecYear,
                subplot = plot) %>% 
  mutate(site = "KNZ",
         ramps = "RampNo",
         experiment = "RaMPs",
         treatment  = case_when(RampNo %in% ambient_ramps ~ "control",
                                RampNo %in% altered_ramps ~ "altered",
                                RampNo %in% control_ramps ~"control_without_shelter")) %>%
  filter(year != "1997") %>% # 1997 was year before shelters were put up
  #group_by(year, season, RampNo, site, ramps, experiment, treatment) %>% 
  #summarize(plot_biomass = mean(plot_biomass)) %>% 
  group_by(year, site, RampNo, treatment) %>% 
  summarize(plot_biomass = mean(plot_biomass)) %>% 
  mutate(experiment = "RaMPs") %>% 
  tidyr::unite("higher_order_organization", experiment, remove = F) %>% #ramps, RampNo
  tidyr::unite("uniqueid", c(higher_order_organization, RampNo), remove = F) %>%
  dplyr::rename(plot = RampNo) %>% 
  dplyr::select(year, site, plot, higher_order_organization, uniqueid, treatment, plot_biomass) %>% 
  mutate(nutrients_added = "no_fertilizer",
         nitrogen_added = 0,
         disturbance = "undisturbed",
         grazing = "ungrazed",
         fire_frequency = 1,
         time_since_fire = 0,
         diversity_manipulated = "naturally_assembled",
         measurement_scale_biomass = 0.1,
         richness = NA,
         evenness = NA,
         measurement_scale_cover = 0.4,
         original_measurement_unit="biomass_g/m2") %>% 
  mutate(treatment_comment = case_when(treatment == "altered" & as.numeric(year) <= 2001 ~ "Could be reduced quantity, altered pattern, or both",
                                       treatment == "altered" & as.numeric(year) == 2001 ~ "Reduced quantity ended",
                                       treatment == "altered" & as.numeric(year) >= 2003 ~ "Heat lamps added to two random subplots",
                                       treatment == "control" ~ "sheltered controls to account for effects from shelter infrastructure",
                                       treatment== "control_without_shelter"~ "unsheltered controls,does not account for effects from shelter infrastructure"))



summary(RaMPs_ANPP$plot_biomass)
hist(RaMPs_ANPP$plot_biomass)

# factors we need: year, site, plot, higher_order_organization, temperature, 
# precipitation, nutrients_added, nitrogen_amount, disturbance, grazing, 
# fire_frequency, time_since_fire, treatment comment, diversity_manipulated,
# plot_biomass, measurement_scale_biomass, richness, evenness, measurement_scale_cover


##### Community composition #####
ambient_ramps <- c(3, 4, 6, 7, 11, 15)
altered_ramps <- c(2,5,9, 10, 12, 13)
control_ramps <- c(1, 8, 14)

#RaMPs_ANPP$year <- as.factor(RaMPs_ANPP$year)
#ramps$RecYear <- as.factor(ramps$RecYear)


# first, have biomass of individual spp in a subplot (per year) as own row
biomass_per_species_SubplotYear <- ramps %>% 
  filter(RecYear != 1997) %>% 
  mutate(A_g_m2 = A*10,
         B_g_m2 = B*10,
         C_g_m2 = C*10,
         D_g_m2 = D*10) %>% 
  dplyr::select(RecType,RecYear,season,RampNo,Species,A_g_m2,B_g_m2,C_g_m2,D_g_m2) %>% 
  group_by(RecYear, season, RampNo, Species) %>% 
  summarize(A_g_m2 = mean(A_g_m2),
            B_g_m2 = mean(B_g_m2),
            C_g_m2 = mean(C_g_m2),
            D_g_m2 = mean(D_g_m2)) %>% 
  ungroup() %>% 
  dplyr::rename(A = A_g_m2,
                B = B_g_m2,
                C = C_g_m2,
                D = D_g_m2) %>% 
  tidyr::gather(key="subplot", value="plot_biomass_spp", A, B, C, D) %>% 
  dplyr::rename(plot = RampNo,
                year = RecYear) %>% 
  group_by(year, season, plot, Species, subplot) %>% 
  filter(plot_biomass_spp > 0) 
  
# next, calculate the total biomass of each subplot from each row, separating by season
biomass_per_SubplotYear <- ramps %>% 
  filter(RecYear != 1997) %>% 
  mutate(A_g_m2 = A*10,
         B_g_m2 = B*10,
         C_g_m2 = C*10,
         D_g_m2 = D*10) %>% 
  dplyr::select(RecType,RecYear,season,RampNo,Species,A_g_m2,B_g_m2,C_g_m2,D_g_m2) %>% 
  group_by(RecYear, season, RampNo, Species) %>% 
  summarize(A_g_m2 = mean(A_g_m2),
            B_g_m2 = mean(B_g_m2),
            C_g_m2 = mean(C_g_m2),
            D_g_m2 = mean(D_g_m2)) %>% 
  ungroup() %>%
  dplyr::rename(A = A_g_m2,
                B = B_g_m2,
                C = C_g_m2,
                D = D_g_m2) %>% 
tidyr::gather(key="subplot", value="plot_biomass_spp", A, B, C, D) %>% 
  dplyr::rename(plot = RampNo,
                year = RecYear) %>% 
  group_by(year, season, plot, subplot) %>% 
  summarize(subplot_total_biomass = sum(plot_biomass_spp))

# finally, consolidate the two objects, divide spp biomass by total biomass during collection, then take maximum relative abundance
ramps_spp_comp <- biomass_per_species_SubplotYear %>% 
  merge(., biomass_per_SubplotYear, by = c("year", "plot", "subplot", "season")) %>% 
  mutate(relative_abundance_subplot = plot_biomass_spp/subplot_total_biomass) %>% 
  group_by(year, plot, season, Species) %>% 
  summarize(plot_biomass_spp_avg_plot = (sum(relative_abundance_subplot)/4)) %>% 
  group_by(year, plot, Species) %>% 
  summarize(relative_abundance = max(plot_biomass_spp_avg_plot)) %>% 
  mutate(site = "KNZ",
         experiment = "RaMPs",
         treatment  = case_when(plot %in% ambient_ramps ~ "control",#made ambient control 
                                plot %in% altered_ramps ~ "altered",
                                plot %in% control_ramps ~ "control_without_shelter")) %>% 
  tidyr::unite("higher_order_organization", experiment, remove = F) %>% #ramps, RampNo
  tidyr::unite("uniqueid", c(higher_order_organization, plot), remove = F) %>%
  dplyr::select(year, site, plot, higher_order_organization, uniqueid, treatment, relative_abundance, Species) %>% 
  mutate(nutrients_added = "no_fertilizer",
         nitrogen_added = 0,
         disturbance = "undisturbed",
         grazing = "ungrazed",
         fire_frequency = 1,
         time_since_fire = 0,
         diversity_manipulated = "naturally_assembled",
         measurement_scale_biomass = 0.1,
         measurement_scale_cover = 0.4,
         original_measurement_unit="biomass_g/m2") %>% 
  mutate(treatment_comment = case_when(treatment == "altered" & as.numeric(year) <= 2001 ~ "Could be reduced quantity, altered pattern, or both",
                                       treatment == "altered" & as.numeric(year) == 2001 ~ "Reduced quantity ended",
                                       treatment == "altered" & as.numeric(year) >= 2003 ~ "Heat lamps added to two random subplots",
                                       treatment == "control_without_shelter" ~ "unsheltered controls does not account for effects of shelter infrastructure",
                                       treatment == "control" ~ "sheltered controls to account for effects of shelter infrastructure"))%>%
  rename(species=Species)





```

# Cleaning data I1 & I2 (NutNet)- Maya
```{r}

#Reading in data
df_I1_KNZ <- read.csv(file.path(L0_dir, "KNZ/I1_NUT011_Sppcomp.csv"), stringsAsFactors = FALSE)
df_I2_KNZ <- read.csv(file.path(L0_dir, "KNZ/I2_NUT012_Biomass.csv"), stringsAsFactors = FALSE)
#I added the Konza species list to the drive as well
spplist <- read.csv(file.path(L0_dir, "KNZ/KNZ_specieslist_PPS011.csv"), stringsAsFactors = FALSE)

##Initial checks

#It does not include watershed info? The Konza website has a map indicating it is in 2C, but nothing is explicitly written in the metadata
unique(sort(df_I1_KNZ$RecYear)) #Data missing for 2020
unique(sort(df_I2_KNZ$RecYear)) #Data missing for 2013 and 2019

unique(sort(df_I1_KNZ$Block))# Blocks 1-3
#The biomass dataframe doesn't have blocks? I'll have to add them in 

unique(sort(df_I1_KNZ$Plot)) # Plots 1-30
unique(sort(df_I2_KNZ$Plot)) #Same plots 1-30

unique(sort(df_I1_KNZ$Subplot)) #Starts with "A", then goes "A1" to "A4", then repeats for B, C, D. It looks like just the "A", "B", "C", and "D" without the numbers attached might be the pre-treatment year only (2007)
unique(sort(df_I2_KNZ$Subplot)) #Has "1" and "2", then "A1" to "A4", then repeats for B, C, D. "1" and "2" are only for 2007, the pre-treatment year.

##I TALKED TO KIM AND SHE SAID SUBPLOT DOESN'T REALLY MATTER... JUST SUMMARIZE BY PLOT

#Might cut out the pre-treatment year (2007)? Unsure what we want to do... but since the plots are named differently too, it might just be easier.

unique(sort(df_I1_KNZ$Taxa)) #Some misspelled species and different capitalizations... will merge with the spp_list dataset to standardize the names for when we combine with other datasets





##Cleaning I1

#Removing 2007 from dataset since it was a pre-treatment year and has different plot names
#Also removing the one "litter" entry
df_I1_KNZ.clean <- df_I1_KNZ %>% subset(RecYear != 2007) %>% subset(Taxa != "litter")


#Redoing some of the sppcodes to match the Konza Spp list
#Also, I am making all the unknowns the same sppcode because that is what I did for ConSME data.
#Now I am second guessing what I am doing for the unknowns. Maybe they should be all be assigned their own spp code.
for(i in 1:nrow(df_I1_KNZ.clean)){
  # if(df_I1_KNZ.clean$Sppnum[i] == 946){df_I1_KNZ.clean$Sppnum[i] <- -999}
  if(df_I1_KNZ.clean$Sppnum[i] == 795){df_I1_KNZ.clean$Sppnum[i] <- 246}
  if(df_I1_KNZ.clean$Sppnum[i] == 726){df_I1_KNZ.clean$Sppnum[i] <- 246}
  # if(df_I1_KNZ.clean$Sppnum[i] == 792){df_I1_KNZ.clean$Sppnum[i] <- -999}
  # if(df_I1_KNZ.clean$Sppnum[i] == 708){df_I1_KNZ.clean$Sppnum[i] <- -999}
  if(df_I1_KNZ.clean$Sppnum[i] == 951){df_I1_KNZ.clean$Sppnum[i] <- 518}
  if(df_I1_KNZ.clean$Sppnum[i] == 746){df_I1_KNZ.clean$Sppnum[i] <- 289}
}

#Taking just the columns I want (for now) from the species list
#This us the same as what I did for ConSME data, just copying here so they can be run independently of each other
spplist_short <- spplist %>% 
  unite(species, genus:species, sep = "_" ) %>%
  mutate(Sppnum = code) %>%
  dplyr::select(Sppnum, species) %>%
  add_case(Sppnum =c(-999, 0), 
           species = c("unknown","bare_ground"))

#Joining with the shortened Konza species list
df_I1_KNZ.clean <- left_join(df_I1_KNZ.clean, spplist_short, by = "Sppnum")%>%
  select(!species)



#Renaming columns to match outline
df_I1_KNZ.clean1 <- df_I1_KNZ.clean %>%
  rename(rectype = RecType,
         source = DataCode,
         year = RecYear,
         date = Date,
         season = Season,
         block = Block,
         plot = Plot,
         sppcode = Sppnum,
         species = Taxa,
         abundance = Cover,
         comments = Comments) %>%
  group_by(rectype, source, year, block, plot, season, sppcode, species) %>%
  summarize(abund = mean(abundance, na.rm=T)) %>%#taking the average of the subplots
  group_by(rectype, source, year, block, plot, sppcode, species) %>%
  summarize(abundance = max(abund, na.rm=T))%>%#taking the highest abundance across season
  mutate(site = as.factor("KNZ"),
         experiment  = "NUTNET") %>%
  unite(higher_order_organization, 
        experiment, site, sep = "_", remove = FALSE) %>% 
  unite(uniqueid, higher_order_organization, block, plot, sep = "_", remove = FALSE) %>%
  mutate(higher_order_organization = as.factor(higher_order_organization),
         uniqueid = as.factor(uniqueid),
         measurement_scale_cover = "1")


## Calculating relative abundance
df_I1_KNZ.clean <- df_I1_KNZ.clean1 %>%
 group_by(year, plot, uniqueid)%>%
  mutate(total_abundance = sum(abundance))%>%
  group_by(year, plot, uniqueid, species)%>%
  mutate(relative_abundance = (abundance/total_abundance))%>%
  ungroup()

## Calculating richness and evenness
I1_richness <- df_I1_KNZ.clean %>%
  community_diversity(time.var = "year",
                      abundance.var = "relative_abundance",
                      replicate.var = "uniqueid", metric = "Shannon")

I1_diversity <- df_I1_KNZ.clean %>% 
  #calculates richness and evenness as Evar
  community_structure(time.var = "year", 
                      abundance.var = "relative_abundance",
                      replicate.var = "uniqueid",
                      metric = "SimpsonEvenness") %>%
  left_join(I1_richness, by = c("year","uniqueid"))
  
#Creating a dataframe for all the distinct descriptive columns
df_I1_KNZ.env <- df_I1_KNZ.clean %>% 
    distinct(source, experiment, year, higher_order_organization, uniqueid, site, block, plot, measurement_scale_cover)

#Joining the diversity dataframe to the distinct columns dataframe
I1_diversity <- left_join(I1_diversity, df_I1_KNZ.env, by = c("year", "uniqueid"), keep = FALSE) %>%
  mutate(plot = as.factor(plot))
    


### I2- NUTNET biomass

#Creating a dataframe to add blocks to the biomass

I2_blocks <- tibble(block = c(rep(1, 20), rep(2, 20), rep(3, 20)), Plot = c(rep(1:30, each = 2)))

df_I2_KNZ.clean <- left_join(df_I2_KNZ, I2_blocks, by = c("Plot"))

#Renaming variables so they match the sppcomp data (and so that they're all lowercase because I'm weird and I need things to match)
df_I2_KNZ.clean <- df_I2_KNZ.clean %>%
  subset(RecYear != 2007) %>% 
  rename(source = DataCode,
         rectype = RecType,
         year = RecYear,
         plot = Plot,
         lvgrass = Lvgrass,
         forb = Forbs,
         woody = Woody,
         pryrdead = Pryrdead,
         total = Total,
         comments = Comments
         ) %>% 
  group_by(source, rectype, year, block, plot) %>% summarize(lvgrass = mean(lvgrass), forb = mean(forb), woody = mean(woody), pryrdead = mean(pryrdead), total = mean(total)*10) %>%
  mutate(plot_biomass=(lvgrass+forb+woody)*10,
         site = "KNZ",
         experiment  = "NUTNET") %>%
  unite(higher_order_organization,
        experiment, site, sep = "_", remove = FALSE) %>%
  unite(uniqueid, higher_order_organization, block, plot, sep = "_", remove = FALSE) %>%
  mutate(higher_order_organization = as.factor(higher_order_organization),
         plot = as.factor(plot),
         uniqueid = as.factor(uniqueid))

# Putting I1_diversity and I2 together
df_I1_I2_KNZ.clean <- left_join(df_I2_KNZ.clean, I1_diversity,
                                by = c("site", "year", "uniqueid", "higher_order_organization", 
                                       "plot", "block", "experiment", "source"), keep = FALSE) %>%
  mutate( measurement_scale_biomass = "0.1")

#After they wouldn't merge correctly, I noticed the plots:subplots are not the same for the diversity and biomass datasets...
unique(sort(I1_diversity$uniqueid))
unique(sort(df_I2_KNZ.clean$uniqueid))
unique(sort(df_I1_KNZ.clean$uniqueid))

#Treatment taken from Konza LTER website... it is a PDF, so I am just recreating the table I guess.
#I am also combining the "subplot" and "spp comp plot" from that table so that it matches these dataframes
KNZ_NUTNET_treatment <- tibble(block = c(rep(1, 10), rep(2, 10), rep(3, 10)),
                    plot = 1:30,
                    # subplot = c("A1", "B1", "D1", "D2", "C3", "B4", "C3", "B3", "C1", 
                    #            "A4", "B1", "D2", "D4", "C1", "B3", "B2", "D4", "D1",
                    #            "C2", "A4", "B4", "D1", "C4", "C1", "A2", "C1", "D2",
                    #            "B4", "C3", "C2"),
                    nutrients_added = c("NP", "NPK", "NPK", "none", "N", "PK", "P", "NK",
                                        "K", "none", "none", "PK", "P", "N", "NPK", "NPK",
                                        "K", "none", "NP", "NK", "none", "none", "P", "NK", 
                                        "N", "PK", "K", "NP", "NPK", "NPK"),
                    treatment = c("NP", "NPK", "NPK_fenced", "control", "N", "PK", "P", "NK",
                                        "K", "fenced", "fenced", "PK", "P", "N", "NPK_fenced", "NPK",
                                        "K", "control", "NP", "NK", "control", "fenced", "P", "NK", 
                                        "N", "PK", "K", "NP", "NPK_fenced", "NPK"),
                    exclosure = c("control", "control", "fenced", "control","control","control","control","control",
                                  "control","fenced", "fenced", "control","control","control","fenced", "control",
                                  "control","control","control","control","control","fenced", "control","control",
                                  "control","control","control","control","fenced", "control")) %>%
  mutate(site = "KNZ", 
         experiment = "NUTNET",
         plot = as.factor(plot),
         nutrients_added = as.factor(nutrients_added),
         treatment = as.factor(treatment),
         exclosure = as.factor(exclosure)) %>%
  unite(higher_order_organization,
        experiment, site, sep = "_", remove = FALSE) %>%
  unite(uniqueid, higher_order_organization, block, plot, sep = "_", remove = FALSE) 


#Final dataset
df_I1_I2_KNZ.clean <- left_join(df_I1_I2_KNZ.clean, KNZ_NUTNET_treatment,
                                by =c("uniqueid","plot","experiment","block","higher_order_organization","site"), keep = FALSE) 

```


#Mary's code-(uploaded and edited by Joshua)
```{r}
#Mary's Code!!! for ChANGE K1_NGE01
# >:)

####Process and clean K1_NGE01_Sppcomp
#read in data, filter for correct years
#K1_spp<-read.csv("K1_NGE01_Sppcomp_RAW_no deluge plots_all years_20240515.csv")%>%
  #filter(year!=2013)%>% #subset all the pre-treatment 2013 year to avoid confusion
  #select(-X,-nitrogen,-treatment,-experiment) #drop unneeded columns
#loading from google drive
K1_spp<-read.csv(file.path(L0_dir, "KNZ/K1_NGE01_Sppcomp_RAW_no deluge plots_all years_20240515.csv"))%>%
  filter(year!=2013)%>% #subset all the pre-treatment 2013 year to avoid confusion
  select(-X,-nitrogen,-treatment,-experiment) #drop unneeded columns

#relative_abundance: calculate so all sum to 1
  #aggregate rows to sum cover across plot and get a "total cover" metric
totalcover_only<-aggregate(K1_spp$abundance,
                           by=list(higher_order_organization=K1_spp$higher_order_organization,
                                   plot=K1_spp$plot,
                                   site=K1_spp$site,
                                   year=K1_spp$year), FUN=sum)
names(totalcover_only)[names(totalcover_only)=="x"] <- "totalcover"

  #add totalcover value to main dataset
K1_spp<-merge(totalcover_only,K1_spp, by=c("site","plot","year","higher_order_organization"))

  #calculate relative abundance in new col then remove the "totalcover" col
K1_spp$relative_abundance <- (K1_spp$abundance/K1_spp$totalcover)
K1_spp <- K1_spp %>% select(-totalcover)

#combine block and plot for the uniqueid col
K1_spp$uniqueid<-paste(K1_spp$higher_order_organization,K1_spp$plot)

#site: update name to fit convention
K1_spp$site[K1_spp$site == 'knz']<-'KNZ'

#original_measurement_unit:
K1_spp$original_measurement_unit<-"%cover"

#write cleaned document
#write.csv(K1_spp, "K1_NGE01_Sppcomp.csv")


####Process and clean K2_NGE01_Biomass
#read in data, filter for correct years
#K1_mass<-read.csv("K2_NGE01_Biomass_RAW_no deluge plots_all years_20240515.csv")%>%
  #filter(year!=2013)%>%
  #rename(plot_biomass=anpp)%>%#subset all the pre-treatment 2013 year to avoid confusion
  #select(-X,-nitrogen,-treatment) #drop unneeded columns
#loading from google drive
K1_mass<-read.csv(file.path(L0_dir, "KNZ/K2_NGE01_Biomass_RAW_no deluge plots_all years_20240515.csv"))%>%
  filter(year!=2013)%>%
  rename(plot_biomass=anpp)%>%#subset all the pre-treatment 2013 year to avoid confusion
  select(-X,-nitrogen,-treatment) #drop unneeded columns

#combine block and plot for the uniqueid col
K1_mass$uniqueid<-paste(K1_mass$higher_order_organization,K1_mass$plot)

#calculate richness and diversity (as evenness) then merge with the main biomass dataset
K1_diversity <- community_structure(K1_spp, time.var = "year", abundance.var = "relative_abundance",
                                  replicate.var = "uniqueid", metric = c("Evar"))

K1_mass<-merge(K1_mass,K1_diversity, by=c("year","uniqueid"))

#add measurement_scale columns
K1_mass$measurement_scale_biomass<-0.1
K1_mass$measurement_scale_cover<-1

#write cleaned document
#write.csv(, "K2_NGE01_Biomass.csv")


####Create K1_NGE01K1_mass metadata file
#Read in biomass dataset and remove unneeded columns
K1_meta<-K1_mass%>%
  select(-measurement_scale_biomass,-measurement_scale_cover,-plot_biomass,-richness,-Evar) #drop unneeded columns

#Load in temperature data, calculate MAT, merge with main dataset
#df_temp <- read.csv("Temperature_1982_2023.csv")%>%
  #filter(TAVE!=".")%>%
  #rename(year=RECYEAR)

#df_temp_ave_year <- df_temp %>% 
  #group_by(year) %>%
  #summarize(temperature=mean(as.numeric(TAVE)))

#K1_meta<-merge(K1_meta,df_temp_ave_year, by=c("year"))

#precipitation: load data, calculate annual precip, merge with main dataset
#df_ppt <- read.csv("Precipitation_1982_2023.csv")%>%
  #filter(ppt!=".")
#df_ppt[is.na(df_ppt)] <- 0

  #Convert the date column to Date type, then extract year and day of year
#df_ppt$RecDate<- as.Date(df_ppt$RecDate, format = "%m/%d/%Y")
#df_ppt$year <- year(df_ppt$RecDate)

  #average across year
#df_ppt_ave_year <- df_ppt %>% 
  #group_by(year) %>%
  #summarize(precipitation=sum(as.numeric(ppt)))

  #merge with main dataset
#K1_meta<-merge(K1_meta,df_ppt_ave_year, by=c("year"))

#growing_precipitation: calculate growing season precip, merge with main dataset
#df_ppt$doy <- strftime(df_ppt$RecDate, format = "%j")
#df_ppt$doy<-as.numeric(df_ppt$doy)

  #filter dataset based on growing season defined for KNZ as 85-278 in Robinson etal 2012 
#df_ppt_gs<-filter(df_ppt,doy>=85&doy<=278)

#average across year
#df_ppt_ave_year_gs <- df_ppt_gs %>% 
  #group_by(year) %>%
  #summarize(growing_precipitation=sum(as.numeric(ppt)))

#merge with main dataset
#K1_meta<-merge(K1_meta,df_ppt_ave_year_gs, by=c("year"))

#load in nitrogen treatment info then merge datasets
#K1_N<-read.csv("dropbox_plotlist_trts_copy.csv")%>%
  #rename(higher_order_organization=block, nitrogen_amount=nitrogen) #drop unneeded columns
#loading directly from google drive
K1_N<-read.csv(file.path(L0_dir,"KNZ/dropbox_plotlist_trts_copy.csv"))%>%
  rename(higher_order_organization=block, nitrogen_amount=nitrogen) #drop unneeded columns


K1_meta<-merge(K1_meta,K1_N, by=c("plot","higher_order_organization"))

#treatment:
K1_meta$treatment<-ifelse(K1_meta$nitrogen_amount=="0","control","treatment")

#nutrients_added:
K1_meta$nutrients_added<-ifelse(K1_meta$nitrogen_amount=="0","no_fertilizer","N")

#disturbance:
K1_meta$disturbance<-"undisturbed"

#grazing:
K1_meta$grazing<-"ungrazed"

#fire_frequency:
K1_meta$fire_frequency<-1

#time_since_fire: 
K1_meta$time_since_fire<-0

#Source:
K1_meta$source<-"personal_most_recent_version_only_portion_on_Konza_site"

#treatment_comment:
K1_meta$treatment_comment<-"does_not_apply"

#diversity_manipulated
K1_meta$diversity_manipulated<-"naturally_assembled"

#write cleaned document
#write.csv(K1_meta, "K3_NGE01_Metadata.csv")
```
#Rachael's code for VI data-edited and uploaded by Joshua
```{r}
# watershed, experiment, block, plot

#VI_11 <- read.csv("VIR011_raw.csv", stringsAsFactors = F)
#VI_12 <- read.csv("VIR012.csv", stringsAsFactors = F)
#VI_2023 <- read.csv("VI_2023_scomp_clean.csv", stringsAsFactors = F)
#Precipitation <- read.csv("Precipitation_1982_2023.csv", stringsAsFactors = F)
#Temp <- read.csv("Temperature_1982_2023.csv", stringsAsFactors = F)

#loading data from gogle drive
VI_11<-read.csv(file.path(L0_dir, "KNZ/B1_VIR011_Sppcomp.csv"), stringsAsFactors = F)
VI_12<-read.csv(file.path(L0_dir, "KNZ/B2_VIR012_Biomass.csv"), stringsAsFactors = F)

#cleaning biomass data
VI_biomass <- VI_12 %>% 
  mutate(plot_id = paste(Block, Plot, sep = "_")) %>% 
  select(-Pryrdead) %>% 
  group_by(RecYear, Lvgrass, Forbs, Woody, plot_id) %>% 
  mutate(Lvgrass=mean(Lvgrass,na.rm=T,Forbs=mean(Forbs,na.rm=T),Woody=mean(Woody,na.rm=T),
         plot_biomass = (Lvgrass + Forbs + Woody))) %>% 
  ungroup() %>% 
  select(-Datacode, -Rectype, -Lvgrass, -Forbs, -Woody, -Comments) %>% 
  rename(year = RecYear) %>% 
  mutate(site = "KNZ") %>% #adding site
  mutate(watershed = "2c") %>% 
  mutate(experiment = "VI") %>% 
  mutate(higher_order_organization = paste(watershed, experiment, Block, Plot, SubPlot, sep = "_"))
  
VI_tidy <- VI_11 %>% 
  mutate(RecSeason = ifelse(RecSeason %in% "fall", "Fall", RecSeason)) %>% 
  mutate(RecSeason = ifelse(RecSeason %in% "spring", "Spring", RecSeason)) %>% 
  mutate(species = paste(Ab_genus, AB_species, sep = "_")) %>% 
  mutate(plot_id = paste(Block, Plot, Subplot, sep = "_"))

VI_tidy$species = toupper(VI_tidy$species) #names not entered consistently

#treatment key
trt_key_VI <- data.frame(Plot=levels(factor(VI_tidy$Plot)),trt_combo=
                           c("NCI","NCI","CCC","NCC", "CCI", "NCC", "CCC", "CCI", 
                             "CCI", "NCI", "NCC", "NCI", "CCC", "CCI", "NCC", "CCC",
                             "NCI", "CCI", "CCC", "NCI", "CCC", "CCI", "NCC", "NCC")) %>% 
  mutate(Plot = as.integer(Plot))

VI_tidier <- VI_tidy %>% #second round - cleaning up entry errors and unneeded data
  mutate(RecSeason = ifelse(RecSeason %in% "fall", "Fall", RecSeason)) %>% 
  mutate(RecSeason = ifelse(RecSeason %in% "spring", "Spring", RecSeason)) %>% 
  mutate(species = paste(Ab_genus, AB_species, sep = "_")) %>% 
  left_join(trt_key_VI, by = "Plot")%>%
  filter(!species == "NA_NA") %>% 
  filter(!species == "BARE_GROUND") %>% 
  filter(!species == "LITTER_") %>% 
  filter(!species == "DUNG_") %>% 
  mutate(species = ifelse(species %in% "DICHANTHELIUM_OLIGOSANTHES", "DICANTHELIUM_OLIGOSANTHES", species)) %>%
  mutate(species = ifelse(species %in% "SCHIZACHYRIUM_SCOPARIUS", "SCHIZACHYRIUM_SCOPARIUM", species)) %>%
  mutate(species = ifelse(species %in% "CYPERUS_SPP.", "CYPERUS_SPP", species)) %>% 
  mutate(site = "KNZ") %>% #adding site name
  rename(year = RecYear) %>% 
  rename(abundance = Cover) %>% 
  select(-Comments, - SpeCode, -Ab_genus, -AB_species)

as.integer(VI_tidier$year)

VI_rel_abundance <- VI_tidier %>% 
  group_by(site, year, plot_id, species) %>% 
  summarize(ab_max = max(abundance)) %>% 
  mutate(relative_abundance = ab_max / sum(ab_max)) %>% 
  ungroup()
  
commMetrics <- community_structure(VI_rel_abundance, abundance.var='relative_abundance', replicate.var='plot_id', time.var = 'year') %>% 
  rename(plot = "plot_id")
commMetrics2 <- community_structure(VI_rel_abundance, abundance.var='relative_abundance', replicate.var='plot_id', time.var = 'year') %>% 
  rename(plot = "plot_id")

commMetricsBio <- commMetrics2 

####final Species comp datasheet####
spp_comp <- VI_rel_abundance %>% 
  rename(plot = plot_id) %>% #block, plot, subplot
  mutate(watershed = "2c") %>% #adding watershed
  mutate(higher_order_organization = paste(site, "VI", watershed, sep = "_")) %>% #site, experiment, watershed
  mutate(uniqueid = paste(higher_order_organization, plot, sep = "_")) %>% 
  rename(abundance = ab_max) %>% 
  mutate(original_measurement_unit = "%cover") %>%
  select(year, site, plot, higher_order_organization, uniqueid, species, abundance, relative_abundance, original_measurement_unit) #ordering columns

burn_y <- c(2009, 2011, 2013, 2015, 2017, 2021) #adding in burn years

trt_key_VI <- data.frame(Plot=levels(factor(VI_tidy$Plot)),trt_combo=
                           c("NCI","NCI","CCC","NCC", "CCI", "NCC", "CCC", "CCI", 
                             "CCI", "NCI", "NCC", "NCI", "CCC", "CCI", "NCC", "CCC",
                             "NCI", "CCI", "CCC", "NCI", "CCC", "CCI", "NCC", "NCC")) %>% 
  mutate(Plot = as.factor(Plot)) #plot and treatment key
nutrient_key <- data.frame(Plot=levels(factor(VI_tidy$Plot)), nutrients=
                           c("NPK+","NPK+","no_fertilizer","NPK+", "no_fertilizer", "NPK+", "no_fertilizer", "no_fertilizer", "no_fertilizer", "NPK+", "NPK+", "NPK+", "no_fertilizer", "no_fertilizer", "NPK+", "no_fertilizer","NPK+", "no_fertilizer", "no_fertilizer", "NPK+", "no_fertilizer", "no_fertilizer", "NPK+", "NPK+")) %>% 
  mutate(Plot = as.factor(Plot)) #plot and treatment key

keys_together <- nutrient_key %>% 
  left_join(trt_key_VI, by = "Plot")

#Hey Rachael, not sure what is going on here! I will just comment them out
#data <- data %>%
 # mutate(middle_number = str_extract(code, "(?<=\\_)[0-9]+(?=\\_)"))

biomass <- VI_12 %>% 
  # mutate(plot = paste(Block, Plot, SubPlot, sep = "_")) %>% 
  select(-Comments, -Pryrdead) %>% 
  mutate(plot_biomass = (Lvgrass + Forbs + Woody)*10) %>% 
  rename(year = RecYear) %>% 
  # select(year, plot, Plot, plot_biomass) %>% 
  group_by(year, Block, Plot) %>% 
  summarize(total_biomass = mean(plot_biomass,na.rm=T)) %>% 
  rename(block = Block) %>% 
  rename(plot = Plot) %>% 
  ungroup()
#replacing missing value
biomass$total_biomass[biomass$total_biomass == -14567.0] <- NA
  # separate(biomass, into = c("Block", "Plot", "Subplot"), sep = "_")

  # mutate(block_subplot = str_extract(biomass, "^[^_]+_[^_]+")) #separating block and subplot

sppBio <- spp_comp %>%
  separate(plot, into = c("block", "plot", "subplot"), sep = "_") %>% 
  mutate(block = as.integer(block), plot = as.integer(plot)) %>% 
  left_join(biomass, by = c("year", "block", "plot")) %>% 
  rename(plot_biomass = total_biomass) %>% 
  mutate(plot = paste(block, plot, subplot, sep = "_"))

richBio <- sppBio %>%
  left_join(commMetricsBio, by = c("year", "plot"))

plotyear <- richBio %>% 
  #left_join(ave_selectedTemp, by = "year") %>% 
  mutate(fire_frequency = 2) %>% 
  mutate(treatment_comment = "cessation following 2018") %>% 
    mutate(time_since_fire = ifelse(year %in% burn_y, "0", "1")) %>% 
  mutate(source = "B1_VIR011_Sppcomp.csv") %>% 
  mutate(Plot = str_extract(plot, "(?<=\\_)[0-9]+(?=\\_)")) %>% #pulling out plot to join dataset of treatment key
  left_join(keys_together, by = "Plot") %>% 
  rename(evenness = Evar)
  
plotyear_treat <- plotyear %>%
  mutate(trt_combo = ifelse(trt_combo == "NCI", "NPK+ & insecticide",
                            ifelse(trt_combo == "CCC", "control",
                                   ifelse(trt_combo == "NCC", "NPK+", 
                                          ifelse(trt_combo == "CCI", "insecticide", as.character(trt_combo)))))) %>%
  rename(treatment = trt_combo) %>%
  mutate(measurement_scale_biomass = "0.1",
         grazing = "ungrazed",
         disturbance = ifelse(nutrients == "no_fertilizer", "undisturbed", "disturbed")) %>% 
  mutate(diversity_manipulated = "naturally_assembled") %>% 
  rename(nutrients_added = nutrients) %>% 
  mutate(measurement_scale_cover = "1")


####final full datasheet#####

final <- plotyear_treat %>% #ordering columns and checking presence
  select(year, site, plot, higher_order_organization, uniqueid, treatment, nutrients_added, disturbance, grazing, fire_frequency, time_since_fire, source, treatment_comment, diversity_manipulated, plot_biomass, measurement_scale_biomass, richness, evenness, measurement_scale_cover, abundance, relative_abundance, species)

#separate metadata deom biomass and species abundance data
#metadata
B1_B2_metadata<-final%>%
  select(year,site,plot,higher_order_organization,uniqueid,treatment,nutrients_added, disturbance, grazing, fire_frequency, time_since_fire, source, treatment_comment, diversity_manipulated)%>%
  distinct()
#plot level metrics with biomass
B2_plot_biomass<-final%>%
  select(year,site,plot,higher_order_organization,uniqueid, plot_biomass, measurement_scale_biomass,measurement_scale_cover)%>%
  distinct()
#spp comp data
B1_sppcomp<-final%>%
  select(year,site,plot,higher_order_organization,uniqueid, species, relative_abundance,abundance)%>%
  mutate(original_measurement_unit="%cover")
```


Mary's code (Konza longest datasets)-uploaded and edited by Joshua
```{r}
#read in data, remove unneeded cols
F1_AB_spp_soil_allwatersheds<-read.csv(file.path(L0_dir,"KNZ/F1_PVC021_Sppcomp_RAW.csv"))%>%
  filter(RecYear!="1983")%>% #Remove 1983 data, no corresponding biomass data is on record
  rename(gen=AB_genus,spec=AB_species,code=SpeCode,plot=Plot,year=RecYear)%>%
  select(-DataCode,-RecType,-Comments,-Pid,-RecDay) #drop unneeded columns 

#Exclude all watershed data that isn't replicated in the ANPP data
#All data needs biomass and sppcomp--only three watersheds have associated biomass: 001d,004b,020b
F1_AB_spp_allsoil <- F1_AB_spp_soil_allwatersheds %>% 
  filter(WaterShed=="001d"|WaterShed=="004b"|WaterShed=="020b"|WaterShed=="002c"|WaterShed=="002d"|WaterShed=="004a") #should leave us with 201278 rows

#We do not have production data for all years in all water sheds: but sppcomp from 1984-2023
 #001d: 1984-2023
 #004b: 1984-2023
 #020b: 1984-2023
 #002c: 1993-2016*
 #002d: 1985-2016*
 #004a: 1993-2016*

#Exclude the years of sppcomp data that aren't found in biomass data
  #file starts with 201278 rows
F1_AB_spp_allsoil <- F1_AB_spp_allsoil %>% 
  filter(!(WaterShed=="002c"&(year<1993|year>2016|year==2015)))
F1_AB_spp_allsoil <- F1_AB_spp_allsoil %>% 
  filter(!(WaterShed=="002d"&(year<1985|year>2016|year==2015)))
F1_AB_spp_allsoil <- F1_AB_spp_allsoil %>% 
  filter(!(WaterShed=="004a"&(year<1993|year>2016|year==2015)))
#removing 20 year fire frequency to avoid incorporating shrubland/woodland
F1_AB_spp_allsoil<-F1_AB_spp_allsoil%>%
  filter(WaterShed!="020b")

#Exclude all soil data that isn't replicated in the ANPP data
#All data needs biomass and sppcomp--only two soiltypes have associated biomass: t (tully soils) and f (florence soils)
F1_AB_spp_soil <- F1_AB_spp_allsoil %>% 
  filter(SoilType=="f"|SoilType=="t") #should leave us with 109607 rows

#Update soil abbreviations to match biomass data
F1_AB_spp_soil$SoilType[F1_AB_spp_soil$SoilType == "f"]<-"fl"
F1_AB_spp_soil$SoilType[F1_AB_spp_soil$SoilType == "t"]<-"tu"

#Combine Watershed, Transect, and Soiltype to create higher order organization then create the uniqueID col
F1_AB_spp_soil$higher_order_organization<-paste(F1_AB_spp_soil$WaterShed, F1_AB_spp_soil$Transect,F1_AB_spp_soil$SoilType,sep="_")
F1_AB_spp_soil$uniqueid<-paste(F1_AB_spp_soil$higher_order_organization, F1_AB_spp_soil$plot, sep="_")

#remove unneeded cols
F1_AB_spp<-select(F1_AB_spp_soil,-WaterShed,-Transect,-SoilType)

#Add site col
F1_AB_spp$site<-"KNZ"

#Check for duplicates
F1_AB_spp[duplicated(F1_AB_spp[,1:10]),]

#F1_PVC021 uses abbreviated names, while we need entire species names
#load and merge with species list
PPS011<-read.csv(file.path(L0_dir,"KNZ/PPS011_Spplist.csv"))%>%
  rename(species_b=species)%>%
  select(-updatedyear,-family,-lifespan,-growthform,-origin,-photo,-Comments) #drop unneeded columns

F1_spp<-merge(F1_AB_spp,PPS011,by=c("gen","spec","code"))

#capitalize genus
F1_spp$genus<-str_to_sentence(F1_spp$genus)

#unite genus and species col to create final species col
F1_spp$species<-paste(F1_spp$genus, F1_spp$species_b, sep=" ")

#drop cols no longer needed for species
F1_spp2<-select(F1_spp, -gen,-spec,-code,-genus,-species_b)

#F1_PVC021 includes data from early and late season, we only need the higher cover
#spread data across months
F1_wide <- pivot_wider(F1_spp2, names_from = RecMonth, values_from = Cover)

#take the max value for all months
F1_wide$abundance <- pmax(F1_wide$"4",F1_wide$"5",F1_wide$"6",F1_wide$"7",F1_wide$"8",F1_wide$"9",F1_wide$"10", na.rm = TRUE)

#drop cols no longer needed
F1_wide<-select(F1_wide, -"4",-"5",-"6",-"7",-"8",-"9",-"10")

#F1_PVC021 uses a modified Daubenmire cover scale--need to covert to % cover
#convert scale to the midpoint cover data  
#1 - 0-1% cover --> 0.5
#2 - 2-5% cover --> 3.5
#3 - 5-25% cover --> 15
#4 - 25-50% cover --> 37.5
#5 - 50-75% cover --> 62.5
#6 - 75-95% cover --> 85
#7 - 95-100% cover --> 97.5

#add original measurement col col
F1_wide$original_measurement_unit<-"%cover"

F1_wide$abundance[F1_wide$abundance == '1']<-0.5
F1_wide$abundance[F1_wide$abundance == '2']<-3.5
F1_wide$abundance[F1_wide$abundance == '3']<-15
F1_wide$abundance[F1_wide$abundance == '4']<-37.5
F1_wide$abundance[F1_wide$abundance == '5']<-62.5
F1_wide$abundance[F1_wide$abundance == '6']<-85
F1_wide$abundance[F1_wide$abundance == '7']<-97.5

#Check for duplicates
F1_wide[duplicated(F1_wide[,1:8]),]

#Calculate relative abundance
#relative_abundance: calculate so all sum to 1
#aggregate rows to sum cover across plot and get a "total cover" metric
totalcover_only<-aggregate(F1_wide$abundance,
                           by=list(higher_order_organization=F1_wide$higher_order_organization,
                                   plot=F1_wide$plot,
                                   site=F1_wide$site,
                                   uniqueid=F1_wide$uniqueid,
                                   year=F1_wide$year), FUN=sum)
names(totalcover_only)[names(totalcover_only)=="x"] <- "totalcover"

#add totalcover value to main dataset
F1_wide2<-merge(totalcover_only,F1_wide, by=c("site","plot","year","uniqueid","higher_order_organization"))

#calculate relative abundance in new col then remove the "totalcover" col
F1_wide2$relative_abundance <- (F1_wide2$abundance/F1_wide2$totalcover)
F1_wide2 <- select(F1_wide2,-totalcover)

#write cleaned document
#write.csv(F1_wide2, "F1_PVC021_Sppcomp.csv")


####Process and clean F1_PAB_Biomass
  #We are using two biomass datasets:
  #PAB011: end-of-season clips on core watersheds: 001d, 004b and 020b.
  #PAB041: end-of-season clips on non-core watershed: 002c, 002d and 004a.

#read in data, remove unneeded cols
F2_1mass<-read.csv(file.path(L0_dir,"KNZ/F2_PAB011_Biomass_RAW.csv"))%>%
  rename(plot=PLOTNUM,year=RECYEAR)%>%
  select(-DATACODE,-RECTYPE,-RECMONTH,-RECDAY,-COMMENTS, -PRYRDEAD) #drop unneeded columns

summary.factor(F2_1mass$WATERSHED)

#read in data, remove unneeded cols
F2_4mass<-read.csv(file.path(L0_dir,"KNZ/F2_PAB041_Biomass_RAW.csv"))%>%
  rename(plot=PLOTNUM,year=RECYEAR)%>%
  select(-DATACODE,-RECTYPE,-RECMONTH,-RECDAY,-COMMENTS, -PRYRDEAD) #drop unneeded columns

  #fix the watershed titles: during 2012, the watersheds of interest are capitalized, not sure why
F2_4mass$WATERSHED[F2_4mass$WATERSHED == '002C']<-"002c"
F2_4mass$WATERSHED[F2_4mass$WATERSHED == '002D']<-"002d"
F2_4mass$WATERSHED[F2_4mass$WATERSHED == '004A']<-"004a"

  #filter for watersheds of interest--Don't know why there are so many watershed--they shouldn't be there
F2_4mass<-filter(F2_4mass,WATERSHED=="001d"|WATERSHED=="004b"|WATERSHED=="020b"|WATERSHED=="002c"|WATERSHED=="002d"|WATERSHED=="004a") #should leave us with 201278 rows
summary.factor(F2_4mass$WATERSHED)

#Bind the two datasets
F2_mass<-rbind(F2_1mass,F2_4mass)
summary.factor(F2_mass$WATERSHED)

#Fix transect to match sppcomp
F2_mass$TRANSECT<-str_to_upper(F2_mass$TRANSECT)
F2_mass[duplicated(F2_mass[,1:9]),]

#Exclude all soil data that isn't replicated in the sppcomp data
#All data needs biomass and sppcomp--only two soiltypes have associated biomass: tu (tully soils) and fl (florence soils)
summary.factor(F2_mass$SOILTYPE)

F2_mass <- F2_mass %>% 
  filter(SOILTYPE=="fl"|SOILTYPE=="tu") #should leave us with 4800 rows

#Add site col
F2_mass$site<-"KNZ"

#Combine Watershed, Transect, and Soil to create higher order organization then create the uniqueID col
F2_mass$higher_order_organization<-paste(F2_mass$WATERSHED, F2_mass$TRANSECT,F2_mass$SOILTYPE,sep="_")
F2_mass$uniqueid<-paste(F2_mass$higher_order_organization, F2_mass$plot, sep="_")
#removing 20 year fire frequency to avoid shrubland/woodland confounding grassland results
F2_mass<-F2_mass%>%
  filter(WATERSHED!="020b")
#drop cols no longer needed for species
F2_mass2<-select(F2_mass,-WATERSHED,-TRANSECT,-SOILTYPE)

#Sum all production to the plot biomass level
F2_mass2[is.na(F2_mass2)] <- 0
F2_mass2$plot_biomass<-rowSums(F2_mass2[,3:6])
F2_mass2$plot_biomass<-10*(F2_mass2$plot_biomass)

#drop cols that are no longer needed
F2_mass3<-select(F2_mass2, -LVGRASS,-FORBS,-CUYRDEAD,-WOODY)

#calculate richness and diversity (as evenness) then merge with the main biomass dataset
F2_diversity <- community_structure(F1_wide2, time.var = "year", abundance.var = "relative_abundance",
                                    replicate.var = "uniqueid", metric = c("Evar"))

F2_mass4<-merge(F2_mass3,F2_diversity, by=c("year","uniqueid"))
  #20 rows dropped: 1991_002d missing species comp data, not worried about this, we have plenty of data

#Add scale data
F2_mass4$measurement_scale_biomass<-0.1
F2_mass4$measurement_scale_cover<-10

#write cleaned document
#write.csv(F2_mass4, "F2_PAB_Biomass.csv")



####Create K1_NGE01 metadata file
#Read in biomass dataset and remove unneeded columns
F3_meta<-F2_mass4%>%
  select(-measurement_scale_biomass,-measurement_scale_cover,-plot_biomass,-richness,-Evar) #drop unneeded columns


#treatment:
F3_meta$treatment<-"control"

#nutrients_added:
F3_meta$nutrients_added<-"no_fertilizer"

#nitrogen_amount:
F3_meta$nitrogen_amount<-0

#disturbance:
F3_meta$disturbance<-"undisturbed"

#grazing:
F3_meta$grazing<-"ungrazed"

#treatment_comment:
F3_meta$treatment_comment<-"does_not_apply"

#diversity_manipulated
F3_meta$diversity_manipulated<-"naturally_assembled"

#fire frequency information:
  #fire is not consistent, so I created an excel sheet that can be merged
fireinfo<-read.csv(file.path(L0_dir,"KNZ/F3_PAB_Metadata_fireinformation.csv"))
  #depends on watershed: need to separate cols temporarily to merge treatment
F3_meta_temp<-separate(F3_meta, higher_order_organization, into = c("watershed_temp", "transect_temp","soil_temp"), sep="_")

F3_meta_fire<-merge(F3_meta_temp,fireinfo,by=c("year","watershed_temp"))

#Bring temporarily separated higher_order_organization column back together
F3_meta_fire$higher_order_organization<-paste(F3_meta_fire$watershed_temp, F3_meta_fire$transect_temp,F3_meta_fire$soil_temp,sep="_")
  #delete the temp cols
F3_meta_fire<-select(F3_meta_fire, -watershed_temp,-transect_temp,-soil_temp)

#before writing the final doc, ensure that all biomass data has corresponding sppcomp data
check_biomass<-F3_meta_fire %>%
  ungroup() %>% 
  dplyr::select(uniqueid,plot) %>%
  unique()

check_sppcomp<-F1_wide2 %>%
  ungroup() %>% 
  dplyr::select(uniqueid, plot) %>%
  unique()

check_all<-merge(check_sppcomp,check_biomass,by=c("uniqueid"),all = TRUE)



```




#precipitation and temperature data-Joshua (modified from Mary's and Smriti's code)
```{r}
 
df_ppt <- read.csv(file.path(L0_dir, "KNZ/Precipitation_1982_2023.csv"), stringsAsFactors = FALSE)
df_temp <- read.csv(file.path(L0_dir, "KNZ/Temperature_1982_2023.csv"), stringsAsFactors = FALSE)
# Convert the date column to Date type 
df_ppt$RecDate<- as.Date(df_ppt$RecDate, format = "%m/%d/%Y")
# Extract the year from the date
df_ppt$year <- year(df_ppt$RecDate)

# Summarizing temperature data
# Averaging across months
df_temp_ave_month <- df_temp %>% 
  group_by(RECYEAR, RECMONTH) %>%
  summarize(mean=mean(as.numeric(TAVE),na.rm=T))

# Averaging across years
df_temp_ave_year <- df_temp %>% 
  group_by(RECYEAR) %>%
  summarize(temperature=mean(as.numeric(TAVE), na.rm=T))%>%
  rename(year=RECYEAR)

#average across year
df_ppt_ave_year <- df_ppt %>% 
  group_by(year) %>%
  summarize(precipitation=sum(as.numeric(ppt),na.rm=T))

#growing_precipitation: calculate growing season precip, merge with main dataset
df_ppt$doy <- strftime(df_ppt$RecDate, format = "%j")
df_ppt$doy<-as.numeric(df_ppt$doy)

  #filter dataset based on growing season defined for KNZ as 85-278 in Robinson etal 2012 
df_ppt_gs<-filter(df_ppt,doy>=85&doy<=278)

#average across year
df_ppt_ave_year_gs <- df_ppt_gs %>% 
  group_by(year) %>%
  summarize(growing_precipitation=sum(as.numeric(ppt),na.rm=T))

weather_df<-df_ppt_ave_year%>%
  left_join(df_ppt_ave_year_gs, by="year")%>%
  left_join(df_temp_ave_year, by="year")

#average MAT and MAP from 1983-2023
weather_avg<-weather_df%>%
  filter(year!=1982)%>%
  summarize(MAT=mean(temperature, na.rm=T),
            MAP=mean(precipitation, na.rm=T))
#MAT=12.8 MAP=844.6

```

#combining all Konza data-Joshua
```{r}
#some extra mop up for species level data
#RaMPs_PlantCommunityComposition<-RaMPs_PlantCommunityComposition%>%
  #mutate(uniqueid=uniqueID)
df_E1_KNZ_species_level$plot<-as.factor(df_E1_KNZ_species_level$plot)
K1_spp$plot<-as.factor(K1_spp$plot)
df_C1_KNZ.cleanest$plot<-as.factor(df_C1_KNZ.cleanest$plot)
df_I1_KNZ.clean$plot<-as.factor(df_I1_KNZ.clean$plot)
#df_J2_KNZ.clean.richness.evenness$plot<-as.factor(df_J2_KNZ.clean.richness.evenness$plot)
#df_C1_KNZ.cleanest$measurement_scale_cover=as.factor(df_C1_KNZ.cleanest$measurement_scale_cover)
ramps_spp_comp$measurement_scale_cover<-as.factor(ramps_spp_comp$measurement_scale_cover)
df_C1_KNZ.cleanest<-df_C1_KNZ.cleanest%>%
  mutate(site="KNZ")
df_I1_KNZ.clean<-df_I1_KNZ.clean%>%
  mutate(original_measurement_unit="%cover")
F1_wide2$plot<-as.factor(F1_wide2$plot)

#combining species level data set
KNZ_specieslevel_abundance<-df_E1_KNZ_species_level%>%
  select(-DataCode,-RecType,-PlotID,-total_abundance,-Spnum,-Treatment)%>%
  bind_rows(K1_spp,df_C1_KNZ.cleanest,df_I1_KNZ.clean)%>%
  select(-10:-16)%>%
  #bind_rows(df_J2_KNZ.clean.richness.evenness)%>% no species identity need to confirm before including
  #select(-10:-22)#%>%
  bind_rows(B1_sppcomp)%>%
  bind_rows(ramps_spp_comp)%>%
  select(-10:-20)%>%
  bind_rows(F1_wide2)


  
#upload to google drive
write.csv(KNZ_specieslevel_abundance,file.path(L1_dir,"/KNZ_specieslevel_abundance.csv"))

#checking abundance duplicate
species_check<-read.csv(file.path(L1_dir, "KNZ_specieslevel_abundance.csv")) %>%
  group_by(uniqueid, year,plot, higher_order_organization,species,site)%>%
  mutate(sum=n())

#data mop up for plot biomass
df_E1_E2_KNZ_clean_plot_metrics<-df_E1_E2_KNZ_clean_plot_metrics%>%
  mutate(original_measurement_unit="%cover")
df_E1_E2_KNZ_clean_plot_metrics$plot<-as.factor(df_E1_E2_KNZ_clean_plot_metrics$plot)
K1_mass$plot<-as.factor(K1_mass$plot)
df_C2_KNZ_cleanest$plot<-as.factor(df_C2_KNZ_cleanest$plot)
df_I1_I2_KNZ.clean$measurement_scale_biomass=as.integer(df_I1_I2_KNZ.clean$measurement_scale_biomass)
df_I1_I2_KNZ.clean$measurement_scale_cover=as.integer(df_I1_I2_KNZ.clean$measurement_scale_cover)
df_I1_I2_KNZ.clean<-df_I1_I2_KNZ.clean%>%
  mutate(plot_biomass=total)
df_I1_I2_KNZ.clean$block=as.factor(df_I1_I2_KNZ.clean$block)
B2_plot_biomass$measurement_scale_biomass=as.numeric(B2_plot_biomass$measurement_scale_biomass)
B2_plot_biomass$measurement_scale_cover=as.numeric(B2_plot_biomass$measurement_scale_cover)
df_C2_KNZ_cleanest$measurement_scale_biomass<-as.numeric(df_C2_KNZ_cleanest$measurement_scale_biomass)
df_C2_KNZ_cleanest$measurement_scale_cover<-as.numeric(df_C2_KNZ_cleanest$measurement_scale_cover)
K1_mass$
K1_mass<-K1_mass%>%
  mutate(original_measurement_unit="%cover")
df_I1_I2_KNZ.clean<-df_I1_I2_KNZ.clean%>%
  mutate(original_measurement_unit="%cover",
         measurement_scale_biomass=0.1,
         measurement_scale_cover=1)
B2_plot_biomass<-B2_plot_biomass%>%
  mutate(original_measurement_unit="%cover")
F2_mass4$measurement_scale_biomass<-as.numeric(F2_mass4$measurement_scale_biomass)
F2_mass4$plot<-as.factor(F2_mass4$plot)
F2_mass4<-F2_mass4%>%
  mutate(original_measurement_unit="%cover")
df_I1_I2_KNZ.clean$measurement_scale_biomass<-as.numeric(df_I1_I2_KNZ.clean$measurement_scale_biomass)
#combining konza plot biomass data
KNZ_plotlevel_metrics<-df_E1_E2_KNZ_clean_plot_metrics%>%
  select(-DataCode,-RecType,-Treatment,-richness,-evenness,-Shannon,-treatment)%>%
  bind_rows(K1_mass)%>%select(-10,-11)%>%
  bind_rows(df_C2_KNZ_cleanest)%>%
  select(-treatment)%>%
  bind_rows(df_I1_I2_KNZ.clean)%>%
  select(-10:-21)%>%
  #,df_J2_KNZ.clean.richness.evenness,RaMPs_ANPP)%>%
  bind_rows(B2_plot_biomass)%>%
  select(-10:-13)%>%
  bind_rows(RaMPs_ANPP)%>%
  select(-10:-20)%>%
  bind_rows(F2_mass4)%>%
  select(-10:-11)%>%
  distinct()

summary(KNZ_plotlevel_metrics)

#upload to google drive
write.csv(KNZ_plotlevel_metrics,file.path(L1_dir,"/KNZ_plotlevel_metrics.csv"))

#mop up of metadata
df_E1_E2_metadata$plot=as.factor(df_E1_E2_metadata$plot)
K1_meta$plot=as.factor(K1_meta$plot)
B1_B2_metadata$plot=as.factor(B1_B2_metadata$plot)
B1_B2_metadata$time_since_fire=as.integer(B1_B2_metadata$time_since_fire)
C1_Meta$plot<-as.factor(C1_Meta$plot)
C1_Meta<-C1_Meta%>%select(-measurement_scale_biomass)
df_I1_I2_KNZ.clean$measurement_scale_biomass<-as.factor(df_I1_I2_KNZ.clean$measurement_scale_biomass)
ramps_spp_comp$measurement_scale_cover<-as.integer(ramps_spp_comp$measurement_scale_cover)
#RaMPs_PlantCommunityComposition$measurement_scale_biomass<-as.factor(RaMPs_PlantCommunityComposition$measurement_scale_biomass)
K1_meta$plot<-as.factor(K1_meta$plot)
F3_meta_fire$plot<-as.factor(F3_meta_fire$plot)


#combine Konza metadata
KNZ_metadata<-df_E1_E2_metadata%>%
  select(-RecType,-Treatment,-source,-watershed)%>%
  bind_rows(K1_meta,C1_Meta)%>%
  select(-16:-18)%>%
  bind_rows(df_I1_I2_KNZ.clean)%>%#%>%#need to include other metadata in NUTNET e.g time_since_fire#df_J2_KNZ.clean.richness.evenness,RaMPs_PlantCommunityComposition)%>%
  select(-16:-31)%>%
  bind_rows(B1_B2_metadata)%>%
  select(-16)%>%
  bind_rows(ramps_spp_comp)%>%
  select(-17:-22)%>%
  bind_rows(F3_meta_fire)%>%
  left_join(weather_df)%>%
  distinct()


summary(KNZ_metadata)

#upload to google drive
write.csv(KNZ_metadata,file.path(L1_dir,"/KNZ_metadata.csv"))


```
